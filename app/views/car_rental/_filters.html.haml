/ Filter/Search Bar
%section.-mt-14.relative.z-10
  .max-w-7xl.mx-auto.px-4.sm:px-6.lg:px-8
    %div{class: 'bg-white/95 backdrop-blur rounded-2xl shadow-xl border border-gray-100 p-4 sm:p-6'}
      = form_with url: (@cars_path || cars_path), method: :get, local: true, class: "grid grid-cols-1 md:grid-cols-4 gap-4 items-end", id: "car_filters" do |f|
        .flex.flex-col
          = f.label :category, "Category", class: "text-xs font-semibold text-gray-700 mb-1"
          = f.select :category, options_for_select([["All Categories", ""]] + @car_categories, params[:category]), {}, class: "block w-full px-4 py-2 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:border-teal-600 focus:ring-teal-600 bg-white text-gray-700 filter-select", data: { filter: "category" }

        .flex.flex-col
          = f.label :brand, "Brand", class: "text-xs font-semibold text-gray-700 mb-1"
          = f.select :brand, options_for_select([["All Brands", ""]] + (@car_brands || []), params[:brand]), {}, class: "block w-full px-4 py-2 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:border-teal-600 focus:ring-teal-600 bg-white text-gray-700 filter-select", data: { filter: "brand" }

        .flex.flex-col
          = f.label :model, "Model", class: "text-xs font-semibold text-gray-700 mb-1"
          = f.select :model, options_for_select([["All Models", ""]] + (@car_models || []), params[:model]), {}, class: "block w-full px-4 py-2 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:border-teal-600 focus:ring-teal-600 bg-white text-gray-700 filter-select", data: { filter: "model" }

        = f.submit "Search", class: "text-white font-bold px-6 py-2 rounded-lg shadow transition w-full", style: "background-color: #3a6363"

:javascript
  document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('car_filters');
    const filterSelects = document.querySelectorAll('.filter-select');
    const filterEndpoint = '#{filter_options_path}';

    // Store original options with normalized keys (lowercase for comparison)
    const originalOptions = {
      category: Array.from(document.querySelector('[data-filter="category"]').options).map(opt => ({ 
        value: opt.value, 
        text: opt.text,
        normalizedValue: opt.value.toLowerCase()
      })),
      brand: Array.from(document.querySelector('[data-filter="brand"]').options).map(opt => ({ 
        value: opt.value, 
        text: opt.text,
        normalizedValue: opt.value.toLowerCase()
      })),
      model: Array.from(document.querySelector('[data-filter="model"]').options).map(opt => ({ 
        value: opt.value, 
        text: opt.text,
        normalizedValue: opt.value.toLowerCase()
      }))
    };

    function updateFilters() {
      const category = document.querySelector('[data-filter="category"]').value;
      const brand = document.querySelector('[data-filter="brand"]').value;
      const model = document.querySelector('[data-filter="model"]').value;

      // Build query params
      const params = new URLSearchParams();
      if (category) params.append('category', category);
      if (brand) params.append('brand', brand);
      if (model) params.append('model', model);

      // Fetch filtered options
      fetch(`${filterEndpoint}?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
          // Normalize backend response to lowercase for comparison
          const normalizedBrands = (data.filtered_brands || []).map(b => b.toLowerCase());
          const normalizedModels = (data.filtered_models || []).map(m => m.toLowerCase());
          const normalizedCategories = (data.filtered_categories || []).map(c => c.toLowerCase());
          
          updateSelectOptions('brand', normalizedBrands);
          updateSelectOptions('model', normalizedModels);
          updateSelectOptions('category', normalizedCategories);
        })
        .catch(error => console.error('Error updating filters:', error));
    }

    function updateSelectOptions(filterName, availableNormalizedValues) {
      const select = document.querySelector(`[data-filter="${filterName}"]`);
      const currentValue = select.value;
      const allOptions = originalOptions[filterName];

      // Clear the select
      select.innerHTML = '';
      
      // Always add the "All" option
      const allOption = allOptions[0];
      select.appendChild(createOption(allOption.value, allOption.text));

      // Add only options that are in availableValues
      allOptions.slice(1).forEach(opt => {
        if (availableNormalizedValues.includes(opt.normalizedValue)) {
          select.appendChild(createOption(opt.value, opt.text));
        }
      });

      // Restore the current value if it still exists
      if (Array.from(select.options).some(opt => opt.value === currentValue)) {
        select.value = currentValue;
      } else {
        select.value = '';
      }
    }

    function createOption(value, text) {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = text;
      return option;
    }

    // Add change listeners to all filter selects
    filterSelects.forEach(select => {
      select.addEventListener('change', updateFilters);
    });

    // Initial update on page load
    updateFilters();
  });