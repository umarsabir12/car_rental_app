/ Filter/Search Bar
%section.-mt-14.relative.z-10
  .max-w-7xl.mx-auto.px-4.sm:px-6.lg:px-8
    %div{class: 'bg-white/95 backdrop-blur rounded-2xl shadow-xl border border-gray-100 p-4 sm:p-6'}
      = form_with url: (@cars_path || cars_path), method: :get, local: true, class: "grid grid-cols-1 md:grid-cols-5 gap-4 items-end", id: "car_filters" do |f|
        .flex.flex-col.relative
          = f.label :search, "Search", class: "text-xs font-semibold text-gray-700 mb-1"
          = f.text_field :search, placeholder: "Brand, Model, Year...", class: "block w-full px-4 py-2 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:border-teal-600 focus:ring-teal-600 bg-white text-gray-700", id: "search_input", autocomplete: "off"
          
          / Search Results Dropdown
          %div{class: "hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 max-h-64 overflow-y-auto", id: "search_results", style: "display: none;"}

        .flex.flex-col
          = f.label :category, "Category", class: "text-xs font-semibold text-gray-700 mb-1"
          = f.select :category, options_for_select([["All Categories", ""]] + @car_categories, params[:category]), {}, class: "block w-full px-4 py-2 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:border-teal-600 focus:ring-teal-600 bg-white text-gray-700 filter-select", data: { filter: "category" }

        .flex.flex-col
          = f.label :brand, "Brand", class: "text-xs font-semibold text-gray-700 mb-1"
          = f.select :brand, options_for_select([["All Brands", ""]] + (@car_brands || []), params[:brand]), {}, class: "block w-full px-4 py-2 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:border-teal-600 focus:ring-teal-600 bg-white text-gray-700 filter-select", data: { filter: "brand" }

        .flex.flex-col
          = f.label :model, "Model", class: "text-xs font-semibold text-gray-700 mb-1"
          = f.select :model, options_for_select([["All Models", ""]] + (@car_models || []), params[:model]), {}, class: "block w-full px-4 py-2 border border-gray-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:border-teal-600 focus:ring-teal-600 bg-white text-gray-700 filter-select", data: { filter: "model" }

        = f.submit "Search", class: "text-white font-bold px-6 py-2 rounded-lg shadow transition w-full", style: "background-color: #3a6363"

:javascript
  // Enhanced initialization with search functionality
  (function initializeFilters() {
    if (!initFiltersNow()) {
      console.warn('Filters not ready, retrying...');
      setTimeout(initFiltersNow, 500);
    }

    function initFiltersNow() {
      try {
        const filterForm = document.getElementById('car_filters');
        const categorySelect = document.querySelector('[data-filter="category"]');
        const brandSelect = document.querySelector('[data-filter="brand"]');
        const modelSelect = document.querySelector('[data-filter="model"]');
        const searchInput = document.getElementById('search_input');
        const searchResults = document.getElementById('search_results');

        if (!filterForm || !categorySelect || !brandSelect || !modelSelect || !searchInput || !searchResults) {
          console.warn('Filter elements not found');
          return false;
        }

        const filterSelects = document.querySelectorAll('.filter-select');
        if (filterSelects.length === 0) {
          console.warn('No filter selects found');
          return false;
        }

        const filterEndpoint = '#{filter_options_path}';
        const searchEndpoint = '#{search_cars_path}';
        
        // Store original options with normalized keys
        const originalOptions = {
          category: Array.from(categorySelect.options).map(opt => ({ 
            value: opt.value, 
            text: opt.text,
            normalizedValue: opt.value.toLowerCase()
          })),
          brand: Array.from(brandSelect.options).map(opt => ({ 
            value: opt.value, 
            text: opt.text,
            normalizedValue: opt.value.toLowerCase()
          })),
          model: Array.from(modelSelect.options).map(opt => ({ 
            value: opt.value, 
            text: opt.text,
            normalizedValue: opt.value.toLowerCase()
          }))
        };

        if (!originalOptions.category.length || !originalOptions.brand.length || !originalOptions.model.length) {
          console.warn('Original options not populated');
          return false;
        }

        // Search functionality
        let searchTimeout;
        searchInput.addEventListener('input', function(e) {
          const query = e.target.value.trim();
          
          clearTimeout(searchTimeout);
          
          if (query.length < 2) {
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
            return;
          }

          searchTimeout = setTimeout(() => {
            fetch(`${searchEndpoint}?query=${encodeURIComponent(query)}`)
              .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
              })
              .then(data => {
                displaySearchResults(data.results, query);
              })
              .catch(error => console.error('Search error:', error));
          }, 300);
        });

        function displaySearchResults(results, query) {
          if (results.length === 0) {
            searchResults.innerHTML = '<div class="px-4 py-2 text-gray-500 text-sm">No results found</div>';
            searchResults.style.display = 'block';
            return;
          }

          searchResults.innerHTML = results.map(result => {
            const highlighted = highlightMatch(result.display_text, query);
            return `
              <div class="search-result-item px-4 py-3 hover:bg-teal-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors"
                   data-brand="${result.brand}"
                   data-model="${result.model}"
                   data-category="${result.category}">
                <div class="text-sm">
                  <span class="font-semibold text-gray-900">${highlighted}</span>
                  <span class="text-gray-500 ml-1">(${result.year})</span>
                </div>
                <div class="text-xs text-gray-600 mt-1">${result.category}</div>
              </div>
            `;
          }).join('');

          searchResults.style.display = 'block';

          // Add click handlers to search results
          document.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', function() {
              const brand = this.dataset.brand;
              const model = this.dataset.model;
              const category = this.dataset.category;
              
              // Set filter values
              brandSelect.value = brand;
              modelSelect.value = model;
              categorySelect.value = category;
              
              // Clear search
              searchInput.value = '';
              searchResults.style.display = 'none';
              
              // Submit the form to navigate to cars index with filters applied
              filterForm.submit();
            });
          });
        }

        function highlightMatch(text, query) {
          const regex = new RegExp(`(${query})`, 'gi');
          return text.replace(regex, '<mark class="bg-yellow-200 font-semibold">$1</mark>');
        }

        function updateFilters() {
          const category = categorySelect.value || '';
          const brand = brandSelect.value || '';
          const model = modelSelect.value || '';

          const params = new URLSearchParams();
          if (category) params.append('category', category);
          if (brand) params.append('brand', brand);
          if (model) params.append('model', model);

          console.log('Fetching filters with params:', params.toString());

          fetch(`${filterEndpoint}?${params.toString()}`)
            .then(response => {
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              return response.json();
            })
            .then(data => {
              console.log('Filter response received:', data);

              const normalizedBrands = (data.filtered_brands || []).map(b => b.toLowerCase());
              const normalizedModels = (data.filtered_models || []).map(m => m.toLowerCase());
              const normalizedCategories = (data.filtered_categories || []).map(c => c.toLowerCase());
              
              updateSelectOptions('brand', normalizedBrands);
              updateSelectOptions('model', normalizedModels);
              updateSelectOptions('category', normalizedCategories);
            })
            .catch(error => console.error('Error updating filters:', error));
        }

        function updateSelectOptions(filterName, availableNormalizedValues) {
          try {
            const select = document.querySelector(`[data-filter="${filterName}"]`);
            if (!select) {
              console.error(`Select for ${filterName} not found`);
              return;
            }

            const currentValue = select.value;
            const allOptions = originalOptions[filterName];

            if (!allOptions) {
              console.error(`Original options for ${filterName} not found`);
              return;
            }

            select.innerHTML = '';
            
            const allOption = allOptions[0];
            if (allOption) {
              select.appendChild(createOption(allOption.value, allOption.text));
            }

            allOptions.slice(1).forEach(opt => {
              if (availableNormalizedValues.includes(opt.normalizedValue)) {
                select.appendChild(createOption(opt.value, opt.text));
              }
            });

            if (Array.from(select.options).some(opt => opt.value === currentValue)) {
              select.value = currentValue;
            } else {
              select.value = '';
            }
          } catch (error) {
            console.error(`Error updating ${filterName} options:`, error);
          }
        }

        function createOption(value, text) {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = text;
          return option;
        }

        // Add change listeners to all filter selects
        filterSelects.forEach(select => {
          select.addEventListener('change', updateFilters);
        });

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
          if (e.target !== searchInput && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
          }
        });

        // Focus to show search results again
        searchInput.addEventListener('focus', function() {
          if (this.value.length >= 2 && searchResults.innerHTML) {
            searchResults.style.display = 'block';
          }
        });

        updateFilters();
        console.log('Filters initialized successfully');
        return true;
      } catch (error) {
        console.error('Error initializing filters:', error);
        return false;
      }
    }
  })();
