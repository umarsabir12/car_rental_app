.container.mx-auto.px-4.sm:px-6.lg:px-8.py-6.sm:py-8
  .max-w-2xl.mx-auto
    .flex.items-center.mb-6
      = link_to admin_discounts_path, class: 'mr-4 text-gray-600 hover:text-gray-900' do
        %i.fas.fa-arrow-left.text-xl
      %h1.text-2xl.sm:text-3xl.font-bold{style: "color: #3A6363;"} New Discount

    .bg-white.rounded-lg.shadow-md.p-6
      = form_with model: [:admin, @discount], local: true, html: { class: 'space-y-6' } do |f|
        - if @discount.errors.any?
          .bg-red-50.border-l-4.border-red-500.p-4.mb-6
            .text-sm.text-red-700
              %h3.font-medium.mb-2
                = pluralize(@discount.errors.count, "error")
                prohibited this discount from being saved:
              %ul.list-disc.list-inside
                - @discount.errors.full_messages.each do |message|
                  %li= message

        .field
          = f.label :vendor_id, 'Vendor (Optional)', class: 'block text-sm font-medium text-gray-700 mb-2'
          = f.select :vendor_id, options_from_collection_for_select(@vendors, :id, :company_name, @discount.vendor_id), { include_blank: 'All Vendors (Category-based discount)' }, { class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:border-transparent', style: 'transition: all 0.2s;', onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'", id: 'vendor-select' }
          %p.text-xs.text-gray-500.mt-1 Select a specific vendor, or leave blank to apply discount to all vendors

        .field
          %label.block.text-sm.font-medium.text-gray-700.mb-2
            Categories
            %span.text-red-500 *
          #category-checkboxes.border.border-gray-300.rounded-md.p-4.bg-white
            - @categories.each do |category|
              .flex.items-center.py-2
                %input{ type: 'checkbox', name: 'discount[category][]', value: category, id: "category_#{category.gsub(/\s+/, '_')}", class: 'h-4 w-4 rounded border-gray-300 focus:ring-2', style: 'color: #3A6363;' }
                %label.ml-2.text-sm.text-gray-700.cursor-pointer{ for: "category_#{category.gsub(/\s+/, '_')}" }= category
          %p.text-xs.text-gray-500.mt-1
            Select categories to apply discount.
            %span.font-semibold Leave empty only if a vendor is selected
            (to apply to all categories of that vendor)

        .field
          = f.label :discount_percentage, 'Discount Percentage', class: 'block text-sm font-medium text-gray-700 mb-2'
          = f.number_field :discount_percentage, step: '1', min: '1', max: '100', placeholder: '10', class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:border-transparent', style: 'transition: all 0.2s;', onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'"
          %p.text-xs.text-gray-500.mt-1 Enter a percentage between 1 and 100

        .field
          = f.label :active, 'Status', class: 'block text-sm font-medium text-gray-700 mb-2'
          .flex.items-center
            = f.check_box :active, { checked: true, class: 'h-4 w-4 rounded border-gray-300 focus:ring-2', style: 'color: #3A6363;' }, true, false
            %span.ml-2.text-sm.text-gray-700 Active

        .flex.gap-3.pt-4
          = f.submit 'Create Discount', class: 'flex-1 px-4 py-2 text-white rounded-md transition shadow-md', style: 'background-color: #3A6363;', onmouseover: "this.style.backgroundColor='#2d4d4d'", onmouseout: "this.style.backgroundColor='#3A6363'"
          = link_to 'Cancel', admin_discounts_path, class: 'flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition shadow-md text-center'

:javascript
  document.addEventListener('DOMContentLoaded', function() {
    const vendorSelect = document.getElementById('vendor-select');
    const categoryCheckboxes = document.getElementById('category-checkboxes');

    // Store the initial HTML with all categories
    const allCategoriesHTML = categoryCheckboxes.innerHTML;

    if (vendorSelect && categoryCheckboxes) {
      vendorSelect.addEventListener('change', function() {
        const vendorId = this.value;

        if (vendorId) {
          // Save current selections
          const currentSelections = Array.from(categoryCheckboxes.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
          categoryCheckboxes.innerHTML = '<div class="text-sm text-gray-500 italic">Loading vendor-specific categories...</div>';

          // Fetch categories for the selected vendor
          fetch(`/admin/discounts/get_categories?vendor_id=${vendorId}`)
            .then(response => response.json())
            .then(data => {
              if (data.categories.length === 0) {
                categoryCheckboxes.innerHTML = '<div class="text-sm text-gray-500 italic">No categories available for this vendor</div>';
                return;
              }

              categoryCheckboxes.innerHTML = '';

              data.categories.forEach(category => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center py-2';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'discount[category][]';
                checkbox.value = category;
                checkbox.id = `category_${category.replace(/\s+/g, '_')}`;
                checkbox.className = 'h-4 w-4 rounded border-gray-300 focus:ring-2';
                checkbox.style.color = '#3A6363';
                // Re-check previously selected categories
                if (currentSelections.includes(category)) {
                  checkbox.checked = true;
                }

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.className = 'ml-2 text-sm text-gray-700 cursor-pointer';
                label.textContent = category;

                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                categoryCheckboxes.appendChild(checkboxDiv);
              });
            })
            .catch(error => {
              console.error('Error fetching categories:', error);
              categoryCheckboxes.innerHTML = '<div class="text-sm text-red-500">Error loading categories</div>';
            });
        } else {
          // Restore all categories when "All Vendors" is selected
          categoryCheckboxes.innerHTML = allCategoriesHTML;
        }
      });
    }
  });
