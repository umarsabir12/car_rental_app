<%= form_with(model: [:admin, @blog], local: true, class: "space-y-6") do |f| %>
  <% if @blog.errors.any? %>
    <div class="bg-red-50 text-red-700 p-4 rounded-md border border-red-200">
      <h2 class="font-bold mb-2"><%= pluralize(@blog.errors.count, "error") %> prohibited this blog from being saved:</h2>
      <ul class="list-disc pl-5 text-sm">
        <% @blog.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="field">
      <%= f.label :title, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= f.text_field :title, class: "w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:border-transparent transition-all", style: "transition: all 0.2s;", onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'" %>
    </div>

    <div class="field">
      <%= f.label :slug, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= f.text_field :slug, class: "w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:border-transparent transition-all font-mono", style: "transition: all 0.2s;", onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'", placeholder: "e.g., best-car-rental-dubai-2025" %>
      <p class="mt-1 text-xs text-gray-500">
        <strong>Format:</strong> lowercase letters, numbers, hyphens only (e.g., 'my-blog-post')
      </p>
    </div>

    <div class="field">
      <%= f.label :category, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= f.text_field :category, class: "w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:border-transparent transition-all", style: "transition: all 0.2s;", onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'" %>
    </div>

    <div class="field">
      <%= f.label :author_name, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= f.text_field :author_name, class: "w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:border-transparent transition-all", style: "transition: all 0.2s;", onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'" %>
    </div>

    <div class="field">
      <%= f.label :published_at, class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= f.datetime_field :published_at, class: "w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:border-transparent transition-all", style: "transition: all 0.2s;", onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'" %>
    </div>
  </div>

  <!-- Document Upload Section -->
  <div class="border-t border-gray-100 pt-6 mt-6">
    <h3 class="text-lg font-bold mb-4" style="color: #3A6363;">Content Upload</h3>
    
    <div class="grid grid-cols-1 gap-6">
      <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
        <%= f.label :document, "Upload Blog Content (.docx only)", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= f.file_field :document, accept: ".docx", class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#3A6363] file:text-white hover:file:bg-[#2d4d4d] transition" %>
        <p class="mt-2 text-xs text-gray-500">
           <% if @blog.new_record? %>
             Upload a Word document to automatically extract formatted content (Headings, Bold, Italic).
           <% else %>
             Upload a new document to <strong>replace</strong> the existing content. Leave empty to keep current content.
           <% end %>
        </p>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <%= f.label :featured_image, "Featured Image", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.file_field :featured_image, class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300" %>
          <% if @blog.featured_image.attached? %>
             <p class="text-xs text-gray-500 mt-1">Current: <%= @blog.featured_image.filename %></p>
          <% end %>
        </div>

        <div>
           <%= f.label :reference_images, "Reference Images / Attachments", class: "block text-sm font-medium text-gray-700 mb-2" %>
           <%= f.file_field :reference_images, multiple: true, class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300", data: { existing_count: @blog.reference_images.count } %>
           <p class="mt-1 text-xs text-gray-500">Referenced as {{resource_1}}, {{resource_2}}...</p>
           <% if @blog.reference_images.attached? %>
                  <p class="text-xs font-semibold mb-1">Current References:</p>
                 <div class="flex flex-wrap gap-2">
                    <% @blog.reference_images.each_with_index do |img, idx| %>
                       <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                         {{resource_<%= idx + 1 %>}}: <%= truncate(img.filename.to_s, length: 15) %>
                       </span>
                    <% end %>
                 </div>
              </div>
           <% end %>
           
           <!-- Client-side Preview -->
           <div id="reference-images-preview" class="mt-2 hidden"></div>

           <script>
             const fileInput = document.getElementById('blog_reference_images');
             const dataTransfer = new DataTransfer();
             const container = document.getElementById('reference-images-preview');
             
             // Get the count of existing images to offset the new index
             const existingCount = parseInt(fileInput.getAttribute('data-existing-count') || "0");

             fileInput.addEventListener('change', function(e) {
               // Add new files to the DataTransfer object
               if (this.files) {
                 Array.from(this.files).forEach(file => {
                   // Check for duplicates to avoid adding the same file twice (optional but good UX)
                   let exists = Array.from(dataTransfer.files).some(f => f.name === file.name && f.size === file.size);
                   if (!exists) {
                     dataTransfer.items.add(file);
                   }
                 });
               }

               // Update the input's files property to include all accumulated files
               this.files = dataTransfer.files;

               // Render Preview
               container.classList.remove('hidden');
               container.classList.add('flex', 'flex-wrap', 'gap-2');
               container.innerHTML = '<p class="text-xs font-semibold mb-1 w-full text-green-700">New Uploads Preview:</p>';
               
               Array.from(dataTransfer.files).forEach((file, index) => {
                 const badge = document.createElement('span');
                 badge.className = 'inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800 border border-green-200';
                 // Index starts at existingCount + 1
                 badge.textContent = `{{resource_${existingCount + index + 1}}}: ${file.name}`;
                 container.appendChild(badge);
               });
             });

             // Loading Indicator Handler
             document.querySelector('form').addEventListener('submit', function() {
               document.getElementById('loading-overlay').classList.remove('hidden');
             });
           </script>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300">
    <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
      <svg class="animate-spin h-10 w-10 text-[#3A6363] mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-gray-700 font-semibold">Processing Blog...</p>
      <p class="text-xs text-gray-500 mt-2">Uploading images & converting content</p>
    </div>
  </div>

  <div class="border-t border-gray-100 pt-6 mt-6">
    <h3 class="text-lg font-bold mb-4" style="color: #3A6363;">SEO/Meta Data</h3>
    <div class="grid grid-cols-1 gap-6">
      <div class="field">
        <%= f.label :meta_title, class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= f.text_field :meta_title, class: "w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:border-transparent transition-all", style: "transition: all 0.2s;", onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'" %>
      </div>

      <div class="field">
         <%= f.label :meta_description, class: "block text-sm font-medium text-gray-700 mb-2" %>
         <%= f.text_area :meta_description, rows: 3, class: "w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:border-transparent transition-all", style: "transition: all 0.2s;", onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'" %>
      </div>
    </div>
  </div>

  <div class="flex justify-end pt-6">
    <%= link_to "Cancel", admin_blogs_path, class: "bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#3A6363] mr-4" %>
    <%= f.submit @blog.new_record? ? "Create Blog" : "Update Blog", class: "inline-flex justify-center py-2 px-6 border border-transparent shadow-md text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#3A6363] transition", style: "background-color: #3A6363;", onmouseover: "this.style.backgroundColor='#2d4d4d'", onmouseout: "this.style.backgroundColor='#3A6363'" %>
  </div>
<% end %>
