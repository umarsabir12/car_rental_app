-# Vendor show page
.container.mx-auto.px-4.sm:px-6.lg:px-8.py-6.sm:py-8
  .bg-white.shadow-lg.rounded-xl.overflow-hidden.p-4.sm:p-6.lg:p-8
    .mb-4.sm:mb-6
      %h1.text-2xl.sm:text-3xl.font-extrabold{style: "color: #3A6363;"} Vendor Details

    / Main Content: Vendor Info + Trade License
    .flex.flex-col.lg:flex-row.gap-6.sm:gap-8
      / Left Side - Vendor Information
      .flex-1
        / Company Name with Status Badge
        .flex.flex-col.sm:flex-row.sm:items-center.gap-3.sm:gap-4.mb-4.sm:mb-6
          %h1.text-2xl.sm:text-3xl.font-bold.text-gray-800= @vendor.company_name
          - if @vendor.is_active?
            %span.inline-flex.items-center.px-3.py-1.rounded-full.text-sm.font-semibold.bg-green-100.text-green-800.border.border-green-300.self-start
              %i.fas.fa-check-circle.mr-1
              Active
          - else
            %span.inline-flex.items-center.px-3.py-1.rounded-full.text-sm.font-semibold.bg-red-100.text-red-800.border.border-red-300.self-start
              %i.fas.fa-ban.mr-1
              Deactivated

        / Vendor Details with Icons
        .space-y-3.sm:space-y-4
          / Contact Person
          .flex.items-start
            %i.fas.fa-user.w-5.sm:w-6.mt-1{style: "color: #3A6363;"}
            .ml-3
              %p.text-xs.font-semibold.text-gray-500.uppercase Name
              %p.text-base.sm:text-lg.text-gray-700= @vendor.name

          / Address
          - if @vendor.address.present?
            .flex.items-start
              %i.fas.fa-map-marker-alt.w-5.sm:w-6.mt-1{style: "color: #3A6363;"}
              .ml-3
                %p.text-xs.font-semibold.text-gray-500.uppercase Address
                %p.text-base.sm:text-lg.text-gray-700= @vendor.address

          / Phone Number
          - if @vendor.phone.present?
            .flex.items-start
              %i.fas.fa-phone.w-5.sm:w-6.mt-1{style: "color: #3A6363;"}
              .ml-3
                %p.text-xs.font-semibold.text-gray-500.uppercase Phone Number
                %p.text-base.sm:text-lg.text-gray-700= @vendor.phone

          / WhatsApp Number
          .flex.items-start
            %i.fab.fa-whatsapp.text-green-600.w-5.sm:w-6.mt-1.text-lg.sm:text-xl
            .ml-3
              %p.text-xs.font-semibold.text-gray-500.uppercase.flex.items-center
                WhatsApp Number
              - if @vendor.whatsapp_number.present?
                .flex.flex-col.sm:flex-row.sm:items-center.gap-2.sm:gap-3
                  %p.text-base.sm:text-lg.text-gray-700= @vendor.whatsapp_display || @vendor.whatsapp_number
                  - whatsapp_url = safe_whatsapp_link(@vendor.whatsapp_link)
                  - if whatsapp_url
                    = link_to whatsapp_url, target: '_blank', class: 'inline-flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold px-3 py-1.5 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg text-sm self-start' do
                      %i.fab.fa-whatsapp
                      %span Chat
              - else
                %p.text-base.sm:text-lg.text-gray-500.italic Not provided

          / Email
          .flex.items-start
            %i.fas.fa-envelope.w-5.sm:w-6.mt-1{style: "color: #3A6363;"}
            .ml-3
              %p.text-xs.font-semibold.text-gray-500.uppercase Email
              %p.text-base.sm:text-lg.text-gray-700.break-all= @vendor.email

          / Website
          - if @vendor.website.present?
            .flex.items-start
              %i.fas.fa-globe.w-5.sm:w-6.mt-1{style: "color: #3A6363;"}
              .ml-3
                %p.text-xs.font-semibold.text-gray-500.uppercase Website
                - safe_url = safe_website_url(@vendor.website)
                - if safe_url
                  = link_to safe_url, safe_url, target: '_blank', class: 'text-base sm:text-lg hover:underline break-all', style: 'color: #3A6363;'
                - else
                  %p.text-base.sm:text-lg.text-gray-700.break-all= @vendor.website

        / Description
        - if @vendor.description.present?
          .mt-4.sm:mt-6.p-4.bg-gray-50.rounded-lg.border.border-gray-200
            %p.text-xs.font-semibold.text-gray-500.uppercase.mb-2 Description
            %p.text-sm.sm:text-base.text-gray-700.leading-relaxed= @vendor.description

        / Invoice Summary Card
        .mt-4.sm:mt-6.p-4.sm:p-5.rounded-lg.border{style: "background: linear-gradient(to right, #e8f0f0, #f0f5f5); border-color: #3A6363;"}
          .flex.flex-col.sm:flex-row.sm:items-center.sm:justify-between.mb-3.sm:mb-4.gap-2
            %h3.text-base.sm:text-lg.font-bold.text-gray-800.flex.items-center.gap-2
              %i.fas.fa-file-invoice-dollar{style: "color: #3A6363;"}
              Invoice Summary
            %span.text-xs.px-2.py-1.rounded-full.font-semibold.self-start{style: "background-color: #d1e0e0; color: #3A6363;"}
              = @vendor.invoices.count
              = "Invoice".pluralize(@vendor.invoices.count)

          .grid.grid-cols-1.sm:grid-cols-2.gap-3.sm:gap-4
            .bg-white.rounded-lg.p-3.shadow-sm
              %p.text-xs.font-semibold.text-gray-500.uppercase Pending Amount
              %p.text-lg.sm:text-xl.font-bold.text-amber-600= number_to_currency(@vendor.total_pending_amount)
            .bg-white.rounded-lg.p-3.shadow-sm
              %p.text-xs.font-semibold.text-gray-500.uppercase Paid Amount
              %p.text-lg.sm:text-xl.font-bold.text-emerald-600= number_to_currency(@vendor.total_paid_amount)

        / Action Buttons
        .flex.flex-wrap.gap-2.sm:gap-3.md:gap-4.mt-6.sm:mt-8
          / Generate Invoice Button (Opens Modal)
          %button.inline-flex.items-center.px-4.sm:px-6.py-2.sm:py-3.text-white.font-medium.rounded-lg.transition-colors.duration-200.shadow-md.hover:shadow-lg.gap-2.text-sm.sm:text-base{type: 'button', onclick: 'openInvoiceModal()', style: 'background-color: #3A6363;', onmouseover: "this.style.backgroundColor='#2d4d4d'", onmouseout: "this.style.backgroundColor='#3A6363'"}
            %i.fas.fa-file-invoice
            %span Generate Invoice

          / Invoice History Button
          = link_to admin_vendor_invoices_path(@vendor), class: 'inline-flex items-center px-4 sm:px-6 py-2 sm:py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg gap-2 text-sm sm:text-base' do
            %i.fas.fa-history
            %span Invoice History

          = button_tag type: 'button', class: 'inline-flex items-center px-4 sm:px-6 py-2 sm:py-3 text-white font-medium rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg gap-2 text-sm sm:text-base', style: 'background-color: #3A6363;', onmouseover: "this.style.backgroundColor='#2d4d4d'", onmouseout: "this.style.backgroundColor='#3A6363'" do
            %i.fas.fa-envelope
            %span Send Email

          / Activation/Deactivation Button
          - if @vendor.is_active?
            = button_to deactivate_admin_vendor_path(@vendor), method: :patch, class: 'inline-flex items-center px-4 sm:px-6 py-2 sm:py-3 bg-orange-600 hover:bg-orange-700 text-white font-medium rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg gap-2 text-sm sm:text-base', data: { confirm: "Are you sure you want to deactivate #{@vendor.company_name}? They will not be able to login until reactivated." } do
              %i.fas.fa-ban
              %span.hidden.sm:inline Deactivate Vendor
              %span.sm:hidden Deactivate
          - else
            = button_to activate_admin_vendor_path(@vendor), method: :patch, class: 'inline-flex items-center px-4 sm:px-6 py-2 sm:py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg gap-2 text-sm sm:text-base' do
              %i.fas.fa-check-circle
              %span.hidden.sm:inline Activate Vendor
              %span.sm:hidden Activate

      / Right Side - Trade License Card
      .flex-shrink-0.w-full.lg:w-96
        .bg-white.rounded-2xl.shadow-xl.border.border-gray-100.overflow-hidden.transition-all.duration-300
          / Header Section
          .px-4.sm:px-6.py-3.sm:py-4.border-b.border-gray-100{style: "background-color: #e8f0f0;"}
            %h2.text-lg.sm:text-xl.font-bold.flex.items-center.gap-2.sm:gap-3{style: 'color:#3A6363'}
              .p-2.rounded-lg{style: 'background-color: #d1e0e0;'}
                %i.fas.fa-id-card{style: 'color:#3A6363'}
              Trade License

          / Content Section
          .p-4.sm:p-6
            - if @vendor.vendor_document.present? && @vendor.vendor_document.trade_license.attached?
              .space-y-3.sm:space-y-4
                / Document Preview
                .w-full.h-32.sm:h-40.rounded-xl.overflow-hidden.bg-gradient-to-br.from-gray-50.to-gray-100.border-2.border-dashed.flex.items-center.justify-center.relative.group.transition-all.duration-300.hover:shadow-lg{style: 'border-color:#3A6363'}
                  - content_type = @vendor.vendor_document.trade_license.content_type.to_s
                  - if content_type.start_with?("image/")
                    = image_tag url_for(@vendor.vendor_document.trade_license.variant(resize_to_fill: [320, 160])), class: 'w-full h-full object-cover transition-transform duration-300 group-hover:scale-110'
                    .absolute.inset-0.bg-black.bg-opacity-0.group-hover:bg-opacity-20.transition-all.duration-300.flex.items-center.justify-center
                      %i.fas.fa-search-plus.text-white.opacity-0.group-hover:opacity-100.text-xl
                  - elsif content_type == 'application/pdf'
                    .text-center.space-y-2
                      %i.fas.fa-file-pdf.text-4xl.sm:text-5xl.text-red-500
                      %span.text-xs.sm:text-sm.font-medium.text-gray-600 PDF Document
                  - else
                    .text-center.space-y-2
                      %i.fas.fa-file-alt.text-4xl.sm:text-5xl.text-gray-400
                      %span.text-xs.sm:text-sm.font-medium.text-gray-600 Document

                / Action Buttons & Status
                .flex.flex-col.gap-2.sm:gap-3
                  / Download Button
                  = link_to url_for(@vendor.vendor_document.trade_license), target: '_blank', class: 'inline-flex items-center justify-center gap-2 px-4 py-2 text-white text-sm font-medium rounded-md transition-all duration-200 shadow hover:shadow-md w-full', style: 'background-color:#3A6363;', onmouseover: "this.style.backgroundColor='#2d4d4d'", onmouseout: "this.style.backgroundColor='#3A6363'" do
                    %i.fas.fa-download
                    %span Download

                  / Show Button
                  - if @vendor.vendor_document.document_status == 'pending'
                    = link_to admin_document_path(@vendor.vendor_document, type: 'trade_license'), target: '_blank', class: 'inline-flex items-center justify-center gap-2 px-4 py-2 text-white text-sm font-medium rounded-md transition-all duration-200 shadow hover:shadow-md w-full', style: 'background-color:#3A6363;', onmouseover: "this.style.backgroundColor='#2d4d4d'", onmouseout: "this.style.backgroundColor='#3A6363'" do
                      %i.fas.fa-eye
                      %span View

                  / Status Badge
                  - status = @vendor.vendor_document.document_status
                  - case status
                  - when 'approved'
                    - badge_classes = 'bg-emerald-50 text-emerald-700 border-emerald-200'
                    - icon_class = 'fas fa-check-circle text-emerald-600'
                  - when 'rejected'
                    - badge_classes = 'bg-red-50 text-red-700 border-red-200'
                    - icon_class = 'fas fa-times-circle text-red-600'
                  - when 'pending'
                    - badge_classes = 'bg-amber-50 text-amber-700 border-amber-200'
                    - icon_class = 'fas fa-clock text-amber-600'
                  - else
                    - badge_classes = 'bg-gray-50 text-gray-700 border-gray-200'
                    - icon_class = 'fas fa-question-circle text-gray-600'

                  .inline-flex.items-center.justify-center.gap-2.px-3.py-2.rounded-lg.text-xs.sm:text-sm.font-semibold.border-2.transition-all.duration-200.w-full{class: badge_classes}
                    %i{class: icon_class}
                    %span= status.to_s.titleize

            - else
              / Empty State
              .text-center.py-6.sm:py-8.space-y-3.sm:space-y-4
                .w-16.h-16.sm:w-20.sm:h-20.mx-auto.rounded-full.flex.items-center.justify-center{style: 'background-color:#E6F0F0'}
                  %i.fas.fa-file-plus.text-xl.sm:text-2xl{style: 'color:#3A6363'}
                .space-y-2
                  %h3.text-sm.sm:text-base.font-semibold.text-gray-800 No Trade License

  / Cars Section
  .mt-6.sm:mt-8
    %h2.text-xl.sm:text-2xl.font-bold.mb-4.sm:mb-6{style: "color: #3A6363;"} Cars by this Vendor
    - if @vendor.cars.any?
      .grid.grid-cols-1.sm:grid-cols-2.lg:grid-cols-3.gap-4.sm:gap-6
        - @vendor.cars.each do |car|
          .bg-white.rounded-lg.shadow.p-3.sm:p-4.flex.flex-col.transition-shadow.hover:shadow-lg
            / Car Image with Uniform Size
            .relative.h-32.sm:h-40.bg-gray-100.rounded-lg.overflow-hidden.mb-2.sm:mb-3
              = car_main_image(car, size: [400, 300])

              / Status Badge
              .absolute.top-2.right-2
                - status_classes = {'available' => 'bg-green-100 text-green-800','rented' => 'bg-red-100 text-red-800'}[car.booking_status] || 'bg-gray-100 text-gray-800'
                %span.inline-block.rounded-full.text-xs.font-semibold.px-2.py-1{ class: status_classes }= car.booking_status&.capitalize

            %div.font-semibold.text-base.sm:text-lg= "#{car.brand} #{car.model}"
            %div.text-sm.sm:text-base.text-gray-500= "#{car.year} • #{car.color} • #{car.transmission&.titleize}"
            -# %div.text-blue-700.font-bold.mt-2= number_to_currency(car.daily_price) + " / day"
            = link_to 'View Car', admin_car_path(car), class: 'mt-2 sm:mt-3 inline-flex items-center justify-center text-white px-4 py-2 rounded shadow text-sm font-bold transition-colors', style: 'background-color: #3A6363;', onmouseover: "this.style.backgroundColor='#2d4d4d'", onmouseout: "this.style.backgroundColor='#3A6363'"
    - else
      %p.text-sm.sm:text-base.text-gray-500 No cars listed by this vendor yet.


/ Invoice Modal
#invoiceModal.fixed.inset-0.bg-gray-900.bg-opacity-50.hidden.z-50.overflow-y-auto
  .flex.items-center.justify-center.min-h-screen.px-4.py-4.sm:py-6
    .bg-white.rounded-xl.sm:rounded-2xl.shadow-2xl.w-full.max-w-4xl.relative.transform.transition-all.max-h-screen.overflow-y-auto
      / Modal Header
      .px-4.sm:px-6.py-3.sm:py-4.rounded-t-xl.sm:rounded-t-2xl.sticky.top-0.z-10{style: "background: linear-gradient(to right, #3A6363, #2d4d4d);"}
        .flex.justify-between.items-center
          %h3.text-base.sm:text-xl.font-bold.text-white
            %i.fas.fa-file-invoice.mr-2
            %span.hidden.sm:inline Generate Invoice for #{@vendor.company_name}
            %span.sm:hidden Generate Invoice
          %button.text-white.hover:text-gray-200.transition-colors{type: 'button', onclick: 'closeInvoiceModal()'}
            %i.fas.fa-times.text-xl.sm:text-2xl

      / Modal Body
      .p-4.sm:p-6
        = form_with(model: [:admin, @vendor, @vendor.invoices.build], local: true, html: { class: 'space-y-4 sm:space-y-6' }) do |f|
          / Hidden field for total amount
          = f.hidden_field :amount, id: 'invoice_amount_field', value: '0'

          / Payment Status
          .grid.grid-cols-1.md:grid-cols-2.gap-4.sm:gap-6
            .space-y-1
              = f.label :payment_status, 'Payment Status', class: 'block text-sm font-medium text-gray-700'
              = f.select :payment_status, Invoice::PAYMENT_STATUSES.map { |status| [status.capitalize, status] }, { selected: 'pending' }, class: 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 text-sm px-3 sm:px-4 py-2 border', style: 'transition: all 0.2s;', onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'"

          / Invoice Items Section
          .space-y-3.sm:space-y-4
            .flex.flex-col.sm:flex-row.sm:items-center.sm:justify-between.gap-2
              %label.block.text-sm.font-medium.text-gray-700 Invoice Items
              %button.inline-flex.items-center.px-3.py-2.text-sm.font-medium.text-white.rounded-md.transition-colors.self-start{type: 'button', onclick: 'addNewInvoiceItem()', style: 'background-color: #3A6363;', onmouseover: "this.style.backgroundColor='#2d4d4d'", onmouseout: "this.style.backgroundColor='#3A6363'"}
                %i.fas.fa-plus-circle.mr-1
                Add Item

            #new-invoice-items-container
              / Initial item row
              .invoice-item-row.bg-gray-50.rounded-lg.p-3.sm:p-4.space-y-3.mb-3
                .flex.items-start.gap-2.sm:gap-3
                  .flex-grow.grid.grid-cols-1.md:grid-cols-2.gap-3
                    .space-y-1
                      %label.block.text-xs.font-medium.text-gray-700 Description
                      %textarea.mt-1.block.w-full.rounded-md.border-gray-300.shadow-sm.focus:border-emerald-500.focus:ring-emerald-500.text-sm.px-3.py-2.border{name: 'invoice[invoice_items_attributes][0][description]', rows: '2', placeholder: 'Item description', required: true, style: 'transition: all 0.2s;', onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'"}

                    .space-y-1
                      %label.block.text-xs.font-medium.text-gray-700 Amount
                      .mt-1.relative.rounded-md.shadow-sm
                        .absolute.inset-y-0.left-0.pl-3.flex.items-center.pointer-events-none
                          %span.text-gray-500.text-sm AED
                        %input.block.w-full.pl-12.pr-3.py-3.sm:py-4.border.border-gray-300.rounded-md.focus:ring-emerald-500.focus:border-emerald-500.text-sm{type: 'number', step: '0.01', name: 'invoice[invoice_items_attributes][0][amount]', placeholder: '0.00', required: true, style: 'transition: all 0.2s;', onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'", onblur: "this.style.borderColor='#d1d5db'; this.style.boxShadow='none'"}

                  %button.inline-flex.items-center.justify-center.w-8.h-8.sm:w-10.sm:h-10.text-red-600.hover:text-red-700.hover:bg-red-50.rounded-md.transition-colors.mt-6{type: 'button', onclick: 'removeNewInvoiceItem(this)'}
                    %i.fas.fa-trash-alt.text-sm.sm:text-base

            / Total Display
            .rounded-lg.p-3.sm:p-4.border{style: "background-color: #e8f0f0; border-color: #3A6363;"}
              .flex.items-center.justify-between
                %span.text-sm.font-semibold.text-gray-700 Total Amount:
                %span#invoice-total.text-lg.sm:text-xl.font-bold{style: "color: #3A6363;"} AED 0.00

          / Submit Button
          .flex.flex-col.sm:flex-row.items-stretch.sm:items-center.justify-end.gap-2.sm:gap-4.pt-4.border-t
            %button.inline-flex.items-center.justify-center.px-4.py-2.border.border-gray-300.shadow-sm.text-sm.font-medium.rounded-md.text-gray-700.bg-white.hover:bg-gray-50.focus:outline-none.focus:ring-2.focus:ring-offset-2{type: 'button', onclick: 'closeInvoiceModal()', style: 'transition: all 0.2s;', onfocus: "this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'"}
              Cancel
            = f.submit 'Create Invoice', class: 'inline-flex items-center justify-center px-6 py-3 border border-transparent text-sm sm:text-base font-medium rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors', style: 'background-color: #3A6363;', onmouseover: "this.style.backgroundColor='#2d4d4d'", onmouseout: "this.style.backgroundColor='#3A6363'"

:javascript
  let newItemIndex = 1;

  function openInvoiceModal() {
    document.getElementById('invoiceModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    calculateInvoiceTotal();
  }

  function closeInvoiceModal() {
    document.getElementById('invoiceModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    // Reset form
    resetInvoiceForm();
  }

  function resetInvoiceForm() {
    const container = document.getElementById('new-invoice-items-container');
    // Remove all items except the first one
    const items = container.querySelectorAll('.invoice-item-row');
    items.forEach((item, index) => {
      if (index > 0) {
        item.remove();
      }
    });
    // Clear the first item
    if (items[0]) {
      items[0].querySelector('textarea').value = '';
      items[0].querySelector('input[type="number"]').value = '';
    }
    newItemIndex = 1;
    calculateInvoiceTotal();
  }

  function addNewInvoiceItem() {
    const container = document.getElementById('new-invoice-items-container');
    const newItem = `
      <div class="invoice-item-row bg-gray-50 rounded-lg p-3 sm:p-4 space-y-3 mb-3">
        <div class="flex items-start gap-2 sm:gap-3">
          <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="space-y-1">
              <label class="block text-xs font-medium text-gray-700">Description</label>
              <textarea name="invoice[invoice_items_attributes][${newItemIndex}][description]" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 text-sm px-3 py-2 border" placeholder="Item description" required oninput="calculateInvoiceTotal()" style="transition: all 0.2s;" onfocus="this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'" onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none'"></textarea>
            </div>
            <div class="space-y-1">
              <label class="block text-xs font-medium text-gray-700">Amount</label>
              <div class="mt-1 relative rounded-md shadow-sm">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <span class="text-gray-500 text-sm">AED</span>
                </div>
                <input type="number" step="0.01" name="invoice[invoice_items_attributes][${newItemIndex}][amount]" class="block w-full pl-12 pr-3 py-3 sm:py-4 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 text-sm" placeholder="0.00" required oninput="calculateInvoiceTotal()" style="transition: all 0.2s;" onfocus="this.style.borderColor='#3A6363'; this.style.boxShadow='0 0 0 3px rgba(58, 99, 99, 0.1)'" onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none'" />
              </div>
            </div>
          </div>
          <button type="button" class="inline-flex items-center justify-center w-8 h-8 sm:w-10 sm:h-10 text-red-600 hover:text-red-700 hover:bg-red-50 rounded-md transition-colors mt-6" onclick="removeNewInvoiceItem(this)">
            <i class="fas fa-trash-alt text-sm sm:text-base"></i>
          </button>
        </div>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', newItem);
    newItemIndex++;
    calculateInvoiceTotal();
  }

  function removeNewInvoiceItem(button) {
    const container = document.getElementById('new-invoice-items-container');
    const items = container.querySelectorAll('.invoice-item-row');

    // Don't allow removing if it's the only item
    if (items.length <= 1) {
      alert('At least one item is required');
      return;
    }

    const itemRow = button.closest('.invoice-item-row');
    itemRow.remove();
    calculateInvoiceTotal();
  }

  function calculateInvoiceTotal() {
    const container = document.getElementById('new-invoice-items-container');
    const amountInputs = container.querySelectorAll('input[type="number"]');
    let total = 0;

    amountInputs.forEach(input => {
      const value = parseFloat(input.value) || 0;
      total += value;
    });

    const totalDisplay = document.getElementById('invoice-total');
    if (totalDisplay) {
      totalDisplay.textContent = 'AED ' + total.toFixed(2);
    }

    // Update the hidden amount field
    const amountField = document.getElementById('invoice_amount_field');
    if (amountField) {
      amountField.value = total.toFixed(2);
    }
  }

  // Add event listeners to initial item for total calculation
  document.addEventListener('DOMContentLoaded', function() {
    const initialTextarea = document.querySelector('#new-invoice-items-container textarea');
    const initialInput = document.querySelector('#new-invoice-items-container input[type="number"]');

    if (initialTextarea) {
      initialTextarea.addEventListener('input', calculateInvoiceTotal);
    }
    if (initialInput) {
      initialInput.addEventListener('input', calculateInvoiceTotal);
    }
  });

  // Close modal when clicking outside
  document.getElementById('invoiceModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      closeInvoiceModal();
    }
  });

  // Close modal on ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeInvoiceModal();
    }
  });
