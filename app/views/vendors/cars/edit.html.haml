.container.mx-auto.max-w-7xl.p-8
  .bg-white.rounded-2xl.shadow-xl.p-12
    %h1.text-4xl.font-extrabold.mb-6{style: 'color:#2d4f4f'} Edit Car
    %p.text-lg.text-gray-700.mb-8 Update the details below to edit your car listing.

    = form_with model: @car, url: vendors_car_path(@car), method: :patch, local: true, html: { multipart: true, class: 'space-y-8' } do |f|
      / Basic Information Section (Required Fields)
      %h2.text-lg.font-bold.mb-4{style: 'color:#2d4f4f'} Basic Information
      .grid.grid-cols-1.md:grid-cols-2.gap-6
        .field.space-y-2
          = f.label :model, 'Model *', class: 'block text-sm font-medium text-gray-700'
          = f.text_field :model, required: true, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., Camry'
        .field.space-y-2
          = f.label :brand, 'Brand *', class: 'block text-sm font-medium text-gray-700'
          = f.text_field :brand, required: true, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., Toyota'
        .field.space-y-2
          = f.label :year, 'Year *', class: 'block text-sm font-medium text-gray-700'
          = f.number_field :year, required: true, min: 1900, max: Date.current.year + 1, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., 2023'
        .field.space-y-2
          = f.label :color, 'Color *', class: 'block text-sm font-medium text-gray-700'
          = f.text_field :color, required: true, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., White'
        .field.space-y-2
          = f.label :daily_price, 'Daily Price (AED) *', class: 'block text-sm font-medium text-gray-700'
          = f.number_field :daily_price, required: true, step: 0.01, min: 0, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., 50.00'
        .field.space-y-2
          = f.label :weekly_price, 'Weekly Price (AED)', class: 'block text-sm font-medium text-gray-700'
          = f.number_field :weekly_price, step: 0.01, min: 0, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., 300.00'
        .field.space-y-2
          = f.label :monthly_price, 'Monthly Price (AED)', class: 'block text-sm font-medium text-gray-700'
          = f.number_field :monthly_price, step: 0.01, min: 0, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., 1200.00'
        .field.space-y-2
          = f.label :status, 'Status *', class: 'block text-sm font-medium text-gray-700'
          = f.select :status, options_for_select([['Available', 'available'], ['Rented', 'rented'], ['Maintenance', 'maintenance']], @car.status), { prompt: 'Select status' }, { required: true, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363' }
        .field.space-y-2.md:col-span-2
          = f.label :category, 'Category', class: 'block text-sm font-medium text-gray-700'
          = f.select :category, options_for_select([['Sedan', 'Sedan'], ['SUV', 'SUV'], ['Sports', 'Sports'], ['Luxury', 'Luxury'], ['Electric', 'Electric'], ['Hybrid', 'Hybrid'], ['Van', 'Van'], ['Truck', 'Truck']], @car.category), { prompt: 'Select category' }, { class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363' }
        .field.space-y-2.md:col-span-2
          = f.label :description, 'Description', class: 'block text-sm font-medium text-gray-700'
          = f.text_area :description, rows: 4, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'Describe the car features, condition, and any special notes...'

      / Specifications Section
      %h2.text-lg.font-bold.mb-4.mt-8{style: 'color:#2d4f4f'} Specifications
      .grid.grid-cols-1.md:grid-cols-2.gap-6
        .field.space-y-2
          = f.label :transmission, 'Transmission', class: 'block text-sm font-medium text-gray-700'
          = f.select :transmission, options_for_select([['Automatic', 'Automatic'], ['Manual', 'Manual'], ['CVT', 'CVT']], @car.transmission), { prompt: 'Select transmission' }, { class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363' }
        .field.space-y-2
          = f.label :fuel_type, 'Fuel Type', class: 'block text-sm font-medium text-gray-700'
          = f.select :fuel_type, options_for_select([['Petrol', 'Petrol'], ['Diesel', 'Diesel'], ['Electric', 'Electric'], ['Hybrid', 'Hybrid'], ['Plug-in Hybrid', 'Plug-in Hybrid']], @car.fuel_type), { prompt: 'Select fuel type' }, { class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition' }
        .field.space-y-2
          = f.label :seats, 'Number of Seats', class: 'block text-sm font-medium text-gray-700'
          = f.number_field :seats, min: 1, max: 15, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., 5'
        .field.space-y-2
          = f.label :mileage, 'Total Mileage (km)', class: 'block text-sm font-medium text-gray-700'
          = f.number_field :mileage, min: 0, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., 15000'
        .field.space-y-2
          = f.label :daily_milleage, 'Daily Mileage (km)', class: 'block text-sm font-medium text-gray-700'
          = f.number_field :daily_milleage, min: 0, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., 100'
        .field.space-y-2
          = f.label :weekly_milleage, 'Weekly Mileage (km)', class: 'block text-sm font-medium text-gray-700'
          = f.number_field :weekly_milleage, min: 0, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., 500'
        .field.space-y-2
          = f.label :monthly_milleage, 'Monthly Mileage (km)', class: 'block text-sm font-medium text-gray-700'
          = f.number_field :monthly_milleage, min: 0, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., 1500'
        .field.space-y-2
          = f.label :additional_mileage_charge, 'Additional Mileage Charge (AED)', class: 'block text-sm font-medium text-gray-700'
          = f.number_field :additional_mileage_charge, step: 0.01, min: 0, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., 1.00'
        .field.space-y-2
          = f.label :engine_size, 'Engine Size', class: 'block text-sm font-medium text-gray-700'
          = f.text_field :engine_size, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: 'e.g., 2.0L'

      / Features Section
      %h2.text-lg.font-bold.mb-4.mt-8{style: 'color:#2d4f4f'} Features
      .grid.grid-cols-1.md:grid-cols-2.gap-6
        .field.space-y-2
          .flex.items-center
            = f.check_box :air_conditioning, class: 'h-4 w-4 border-gray-300 rounded', style: 'accent-color:#3A6363'
            = f.label :air_conditioning, 'Air Conditioning', class: 'ml-2 block text-sm font-medium text-gray-700'
        .field.space-y-2
          .flex.items-center
            = f.check_box :gps, class: 'h-4 w-4 border-gray-300 rounded', style: 'accent-color:#3A6363'
            = f.label :gps, 'GPS Navigation', class: 'ml-2 block text-sm font-medium text-gray-700'
        .field.space-y-2
          .flex.items-center
            = f.check_box :sunroof, class: 'h-4 w-4 border-gray-300 rounded', style: 'accent-color:#3A6363'
            = f.label :sunroof, 'Sunroof', class: 'ml-2 block text-sm font-medium text-gray-700'
        .field.space-y-2
          .flex.items-center
            = f.check_box :bluetooth, class: 'h-4 w-4 border-gray-300 rounded', style: 'accent-color:#3A6363'
            = f.label :bluetooth, 'Bluetooth', class: 'ml-2 block text-sm font-medium text-gray-700'
        .field.space-y-2
          .flex.items-center
            = f.check_box :featured, class: 'h-4 w-4 border-gray-300 rounded', style: 'accent-color:#3A6363'
            = f.label :featured, 'Featured Car', class: 'ml-2 block text-sm font-medium text-gray-700'
        
        .field.space-y-2
          .flex.items-center
            = f.check_box :with_driver, class: 'h-4 w-4 border-gray-300 rounded', style: 'accent-color:#3A6363'
            = f.label :with_driver, 'Rent with Driver', class: 'ml-2 block text-sm font-medium text-gray-700'

      / Insurance Section
      %h2.text-lg.font-bold.mb-4.mt-8{style: 'color:#2d4f4f'} Insurance
      .field.space-y-2
        = f.label :insurance_policy, 'Insurance Policy', class: 'block text-sm font-medium text-gray-700'
        = f.text_field :insurance_policy, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 transition', style: '--tw-ring-color:#3A6363', placeholder: @car.insurance_policy.present? ? @car.insurance_policy : 'e.g., Insurance policy details'

      / Images Section
      %h2.text-lg.font-bold.mb-4.mt-8{style: 'color:#2d4f4f'} Car Images
      
      / Existing Images Display
      - if @car.images.attached? && @car.images.any?
        .mb-6
          %h3.text-md.font-semibold.text-gray-700.mb-3 Current Images (#{@car.images.count})
          .flex.flex-wrap.gap-4.mb-4
            - @car.images.each_with_index do |image, index|
              .relative.group
                .w-32.h-24.rounded-lg.overflow-hidden.shadow-md
                  %img.w-full.h-full.object-cover{ src: url_for(image), alt: "Car image #{index + 1}" }
                .absolute.top-1.right-1
                  %button.text-red-500.hover:text-red-700.bg-white.rounded-full.w-6.h-6.flex.items-center.justify-center.shadow-sm{ type: "button", onclick: "removeImage(#{index})" }
                    %i.fas.fa-times.text-xs
      
      / Add New Images
      %h3.text-md.font-semibold.text-gray-700.mb-3 Add New Images
      .flex.gap-6.mb-4
        - 5.times do |i|
          .relative.group
            %div.flex.items-center.justify-center.w-32.h-24.rounded-xl.shadow.border-2.border-dashed.transition-all.duration-200{ id: "plus-card-#{i}", style: 'border-color:#3A6363; background-color:#eff5f5' }
              %i.fas.fa-plus.text-3xl{ id: "plus-icon-#{i}", style: 'color:#3A6363' }
              %img.hidden.absolute.inset-0.w-full.h-full.object-cover.rounded-xl{ id: "preview-img-#{i}" }
            = f.file_field :images, name: "car[images][]", id: "car_image_#{i}", accept: 'image/*', class: 'hidden', data: { image_index: i }

      .text-sm.text-gray-600.mb-8
        %p Upload additional images to add to your car. You can upload up to 5 images total.

      / Mulkiya Section
      %h2.text-lg.font-bold.mb-4.mt-8{style: 'color:#2d4f4f'} Mulkiya (PDF or Image)
      - if @car.car_document.present? && @car.car_document.mulkiya.attached?
        .mb-3
          .flex.items-center.gap-3
            %i.fas.fa-file{style: 'color:#3A6363'}
            %span.text-gray-700 Current file:
            = link_to (@car.car_document.mulkiya.filename.to_s), url_for(@car.car_document.mulkiya), target: '_blank', class: 'underline', style: 'color:#3A6363'

      .flex.gap-6.mb-6
        .relative.group
          %div.flex.items-center.justify-center.w-32.h-24.rounded-xl.shadow.border-2.border-dashed.transition-all.duration-200{id: 'plus-card-mulkiya-edit', style: 'border-color:#3A6363; background-color:#eff5f5'}
            %i.fas.fa-plus.text-3xl{id: 'plus-icon-mulkiya-edit', style: 'color:#3A6363'}
            %img.hidden.absolute.inset-0.w-full.h-full.object-cover.rounded-xl{id: 'preview-img-mulkiya-edit'}
            %div.hidden.absolute.inset-0.w-full.h-full.flex.items-center.justify-center.rounded-xl{id: 'preview-file-mulkiya-edit'}
              %i.fas.fa-file-pdf.text-3xl.text-red-500
          = f.file_field :mulkiya, id: 'car_mulkiya_edit', accept: 'application/pdf,image/*,.heic,.heif', class: 'hidden'
        .flex.flex-col.justify-center
          %span.text-sm.text-gray-700.font-medium Selected:
          %span#mulkiya-filename-edit.text-sm.text-gray-500 None

      / Submit Button
      .flex.justify-end.pt-6
        = f.submit 'Update Car', class: 'text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200', style: 'background-color:#3A6363'

:javascript
  // Function to remove existing images
  function removeImage(imageIndex) {
    if (confirm('Are you sure you want to remove this image?')) {
      const carId = window.location.pathname.split('/').pop();
      const imageContainer = event.target.closest('.relative');
      
      fetch(`/vendors/cars/${carId}/remove_image`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({ image_index: imageIndex })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Hide the image element
          if (imageContainer) {
            imageContainer.style.display = 'none';
          }
          // Update the image count
          const countElement = document.querySelector('h3');
          if (countElement) {
            const currentCount = parseInt(countElement.textContent.match(/\((\d+)\)/)[1]);
            countElement.textContent = `Current Images (${currentCount - 1})`;
          }
        } else {
          alert('Failed to remove image: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Failed to remove image. Please try again.');
      });
    }
  }

  // Initialize image upload functionality
  function initializeImageUploads() {
    for (let i = 0; i < 5; i++) {
      const fileInput = document.getElementById('car_image_' + i);
      const previewImg = document.getElementById('preview-img-' + i);
      const plusIcon = document.getElementById('plus-icon-' + i);
      const plusCard = document.getElementById('plus-card-' + i);
      
      if (fileInput && previewImg && plusIcon && plusCard) {
        // Remove existing event listeners to prevent duplicates
        const newFileInput = fileInput.cloneNode(true);
        fileInput.parentNode.replaceChild(newFileInput, fileInput);
        
        const newPlusCard = plusCard.cloneNode(true);
        plusCard.parentNode.replaceChild(newPlusCard, plusCard);
        
        // Re-get elements after cloning
        const newFileInputElement = document.getElementById('car_image_' + i);
        const newPlusCardElement = document.getElementById('plus-card-' + i);
        const newPreviewImg = document.getElementById('preview-img-' + i);
        const newPlusIcon = document.getElementById('plus-icon-' + i);
        
        if (newFileInputElement && newPreviewImg && newPlusIcon && newPlusCardElement) {
          newFileInputElement.addEventListener('change', function(e) {
            if (newFileInputElement.files && newFileInputElement.files[0]) {
              const reader = new FileReader();
              reader.onload = function(ev) {
                newPreviewImg.src = ev.target.result;
                newPreviewImg.classList.remove('hidden');
                newPlusIcon.classList.add('hidden');
              };
              reader.readAsDataURL(newFileInputElement.files[0]);
            } else {
              newPreviewImg.src = '';
              newPreviewImg.classList.add('hidden');
              newPlusIcon.classList.remove('hidden');
            }
          });
          
          newPlusCardElement.addEventListener('click', function() {
            newFileInputElement.click();
          });
          
          newPreviewImg.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        }
      }
    }
  }

  // Mulkiya upload placeholder behavior for edit
  function initializeMulkiyaUploadEdit() {
    const fileInput = document.getElementById('car_mulkiya_edit');
    const previewImg = document.getElementById('preview-img-mulkiya-edit');
    const plusIcon = document.getElementById('plus-icon-mulkiya-edit');
    const plusCard = document.getElementById('plus-card-mulkiya-edit');
    const previewFile = document.getElementById('preview-file-mulkiya-edit');
    const fileNameEl = document.getElementById('mulkiya-filename-edit');

    if (!(fileInput && previewImg && plusIcon && plusCard && previewFile && fileNameEl)) return;

    // Prevent duplicate bindings across Turbo renders
    if (plusCard.dataset.initialized === 'true') return;
    plusCard.dataset.initialized = 'true';

    const resetPreview = () => {
      previewImg.classList.add('hidden');
      previewFile.classList.add('hidden');
      plusIcon.classList.remove('hidden');
      fileNameEl.textContent = 'None';
      previewImg.src = '';
    };

    plusCard.addEventListener('click', function() {
      fileInput.click();
    });

    fileInput.addEventListener('change', function() {
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        fileNameEl.textContent = file.name;
        const type = (file.type || '').toLowerCase();

        if (type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            previewImg.src = ev.target.result;
            previewImg.classList.remove('hidden');
            previewFile.classList.add('hidden');
            plusIcon.classList.add('hidden');
          };
          reader.onerror = function() {
            previewImg.classList.add('hidden');
            previewFile.classList.remove('hidden');
            plusIcon.classList.add('hidden');
          };
          reader.readAsDataURL(file);
        } else {
          previewImg.classList.add('hidden');
          previewFile.classList.remove('hidden');
          plusIcon.classList.add('hidden');
        }
      } else {
        resetPreview();
      }
    });
  }

  // Initialize on multiple events to ensure it works
  document.addEventListener('DOMContentLoaded', initializeImageUploads);
  document.addEventListener('turbo:load', initializeImageUploads);
  document.addEventListener('turbo:render', initializeImageUploads);
  document.addEventListener('DOMContentLoaded', initializeMulkiyaUploadEdit);
  document.addEventListener('turbo:load', initializeMulkiyaUploadEdit);
  document.addEventListener('turbo:render', initializeMulkiyaUploadEdit);
  
  // Also initialize immediately if DOM is already ready
  if (document.readyState !== 'loading') {
    setTimeout(initializeImageUploads, 100);
    setTimeout(initializeMulkiyaUploadEdit, 120);
  } 
