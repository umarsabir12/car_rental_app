.container.mx-auto.max-w-7xl.p-6
  = render partial: "vendors/navbar"
  
  / Hero Section with Car Images
  .bg-white.rounded-2xl.shadow-xl.overflow-hidden.mb-8
    .relative.h-96.bg-gradient-to-r.from-blue-50.to-indigo-50
      = car_image_slider(@car, height: 'h-96', show_counter: true, show_navigation: true, show_pagination: true)
    
    / Car Title and Actions
    .p-8
      .flex.flex-col.md:flex-row.md:items-center.md:justify-between.gap-4
        .flex-1
          %h1.text-4xl.font-extrabold.mb-2{style: 'color: #2d4f4f'}= "#{@car.brand} #{@car.model}"
          .flex.items-center.gap-4.mb-4
            %span.text-lg.text-gray-600= @car.year
            %span.text-lg.text-gray-600= @car.color
            %span.text-lg.text-gray-600= @car.category.presence || '—'
          .flex.items-center.gap-4
            - status_classes = {'available' => 'bg-green-100 text-green-700', 'rented' => 'bg-red-100 text-red-700', 'maintenance' => 'bg-yellow-100 text-yellow-700'}
            %span.inline-block.rounded-full.text-sm.font-semibold.px-4.py-2{class: status_classes[@car.status] || 'bg-blue-100 text-blue-700'}= @car.status.titleize
            %span.text-2xl.font-bold{style: 'color: #3a6363'}= @car.daily_price ? number_to_currency(@car.daily_price) : 'N/A'
            %span.text-gray-500   /day
            %span.text-2xl.font-bold{style: 'color: #3a6363'}= @car.weekly_price ? number_to_currency(@car.weekly_price) : 'N/A'
            %span.text-gray-500 /week
            %span.text-2xl.font-bold{style: 'color: #3a6363'}= @car.monthly_price ? number_to_currency(@car.monthly_price) : 'N/A'
            %span.text-gray-500 /month
        .flex.gap-3
          = link_to edit_vendors_car_path(@car), class: 'text-white font-semibold px-6 py-3 rounded-lg transition flex items-center gap-2', style: 'background-color:#3a6363' do
            %i.fas.fa-edit
            Edit Car
          = link_to vendors_car_path(@car), method: :delete, data: { confirm: 'Are you sure you want to delete this car?' }, class: 'bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-3 rounded-lg transition flex items-center gap-2' do
            %i.fas.fa-trash
            Delete

  / Main Content Grid
  .grid.grid-cols-1.lg:grid-cols-3.gap-8
    / Left Column - Car Details
    .lg:col-span-2.space-y-6
      / Rental Terms (from public show)
      .bg-white.rounded-xl.shadow-lg
        .px-6.py-4.border-b
          %h3.font-semibold.text-gray-900 Rental Terms
        .p-6
          .grid.grid-cols-1.sm:grid-cols-2.gap-x-10.gap-y-5.place-items-center.text-center
            .flex.items-center.justify-center.gap-3
              %i.fas.fa-tachometer-alt.text-xl.text-gray-700
              %span.text-gray-800 Mileage Policy
              %button.text-gray-400.hover:text-gray-600{ "data-policy" => "mileage" }
                %i.fas.fa-info-circle
            .flex.items-center.justify-center.gap-3
              %i.fas.fa-gas-pump.text-xl.text-gray-700
              %span.text-gray-800 Fuel Policy
              %button.text-gray-400.hover:text-gray-600{ "data-policy" => "fuel" }
                %i.fas.fa-info-circle
            .flex.items-center.justify-center.gap-3
              %i.fas.fa-hand-holding-usd.text-xl.text-gray-700
              %span.text-gray-800 Deposit Policy
              %button.text-gray-400.hover:text-gray-600{ "data-policy" => "deposit" }
                %i.fas.fa-info-circle
            .flex.items-center.justify-center.gap-3
              %i.fas.fa-file-alt.text-xl.text-gray-700
              %span.text-gray-800 Rental Policy
              %button.text-gray-400.hover:text-gray-600{ "data-policy" => "rental" }
                %i.fas.fa-info-circle

      / Insurance Highlights
      .bg-white.rounded-xl.shadow-lg.mb-6
        .p-6
          .flex.flex-col.sm:flex-row.items-center.justify-center.gap-10.text-center
            .flex.items-center.gap-3
              %span.inline-flex.items-center.justify-center.w-6.h-6.rounded-full.bg-green-500.text-white
                %i.fas.fa-check.text-xs
              %span.text-gray-800 Minimum 5 days rental
            .flex.items-center.gap-3
              %span.relative.group.inline-flex.items-center.justify-center.w-6.h-6.rounded-full.bg-green-500.text-white.cursor-pointer{ 'aria-describedby' => 'insurance-tooltip' }
                %i.fas.fa-check.text-xs
                %span#insurance-tooltip{ class: 'absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-64 rounded-lg bg-[#3A6363] text-white text-sm p-2 shadow-lg hidden group-hover:block whitespace-normal break-words z-10', role: 'tooltip' }
                  = @car.insurance_policy.present? ? @car.insurance_policy : 'No insurance policy provided'
              %span.text-gray-800 Insurance included

      / Basic Information Card
      .bg-white.rounded-xl.shadow-lg.p-6
        %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
          %i.fas.fa-info-circle{style: 'color: #3a6363'}
          Basic Information
        .grid.grid-cols-1.md:grid-cols-2.gap-4
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Model
            %span.text-gray-900= @car.model
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Brand
            %span.text-gray-900= @car.brand
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Year
            %span.text-gray-900= @car.year
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Color
            %span.text-gray-900= @car.color
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Category
            %span.text-gray-900= @car.category.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Daily Price
            %span.text-gray-900= @car.daily_price ? number_to_currency(@car.daily_price) : 'N/A'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Weekly Price
            %span.text-gray-900= @car.weekly_price ? number_to_currency(@car.weekly_price) : 'N/A'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Monthly Price
            %span.text-gray-900= @car.monthly_price ? number_to_currency(@car.monthly_price) : 'N/A'

      / Specifications Card
      .bg-white.rounded-xl.shadow-lg.p-6
        %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
          %i.fas.fa-cogs{style: 'color: #3a6363'}
          Specifications
        .grid.grid-cols-1.md:grid-cols-2.gap-4
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Transmission
            %span.text-gray-900= @car.transmission.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Fuel Type
            %span.text-gray-900= @car.fuel_type.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Seats
            %span.text-gray-900= @car.seats.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Total Mileage
            %span.text-gray-900= @car.mileage.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Daily Mileage
            %span.text-gray-900= @car.daily_milleage.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Weekly Mileage
            %span.text-gray-900= @car.weekly_milleage.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Monthly Mileage
            %span.text-gray-900= @car.monthly_milleage.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Engine Size
            %span.text-gray-900= @car.engine_size.presence || '—'

      / Features & Specs Section (two-column like public page)
      .bg-white.rounded-xl.shadow-lg.p-6
        %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
          %i.fas.fa-star{style: 'color: #3a6363'}
          Features & Specs
        .grid.grid-cols-1.md:grid-cols-2.gap-8
          .div
            %h3.font-semibold.mb-4.text-gray-700 Technical Features
            .space-y-3
              .flex.items-center
                - if @car.air_conditioning
                  %i.fas.fa-check-circle.text-green-500.mr-3
                - else
                  %i.fas.fa-times-circle.text-red-500.mr-3
                %span Automatic Emergency Braking
              .flex.items-center
                - if @car.bluetooth
                  %i.fas.fa-check-circle.text-green-500.mr-3
                - else
                  %i.fas.fa-times-circle.text-red-500.mr-3
                %span Bluetooth Connectivity
              .flex.items-center
                %i.fas.fa-check-circle.text-green-500.mr-3
                %span Power Windows
              .flex.items-center
                %i.fas.fa-check-circle.text-green-500.mr-3
                %span Power Door Locks
          .div
            %h3.font-semibold.mb-4.text-gray-700 Other Features
            .space-y-3
              .flex.items-center
                - if @car.sunroof
                  %i.fas.fa-check-circle.text-green-500.mr-3
                - else
                  %i.fas.fa-times-circle.text-red-500.mr-3
                %span Panoramic Sunroof
              .flex.items-center
                - if @car.gps
                  %i.fas.fa-check-circle.text-green-500.mr-3
                - else
                  %i.fas.fa-times-circle.text-red-500.mr-3
                %span GPS Navigation
              .flex.items-center
                %i.fas.fa-check-circle.text-green-500.mr-3
                %span USB Chargers
              .flex.items-center
                %i.fas.fa-check-circle.text-green-500.mr-3
                %span LED Screens

      / Description Card
      - if @car.description.present?
        .bg-white.rounded-xl.shadow-lg.p-6
          %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
            %i.fas.fa-align-left{style: 'color: #3a6363'}
            Description & Highlights
          %p.text-gray-700.leading-relaxed= @car.description

    / Right Column - Sidebar
    .space-y-6
      / Car Stats Card
      .bg-white.rounded-xl.shadow-lg.p-6
        %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
          %i.fas.fa-chart-bar{style: 'color: #3a6363'}
          Car Stats
        .space-y-4
          .flex.justify-between.items-center.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Created
            %span.text-gray-900= @car.created_at.strftime('%b %d, %Y')
          .flex.justify-between.items-center.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Updated
            %span.text-gray-900= @car.updated_at.strftime('%b %d, %Y')
          .flex.justify-between.items-center.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Total Bookings
            %span.text-gray-900= @bookings.count
          .flex.justify-between.items-center.py-2
            %span.font-medium.text-gray-600 Active Bookings
            %span.text-gray-900= @bookings.where(status: 'Pending').count

      / Quick Actions Card
      .bg-white.rounded-xl.shadow-lg.p-6
        %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
          %i.fas.fa-bolt{style: 'color: #3a6363'}
          Quick Actions
        .space-y-3
          = link_to edit_vendors_car_path(@car), class: 'w-full text-white font-medium px-4 py-3 rounded-lg transition flex items-center justify-center gap-2', style: 'background-color:#3A6363' do
            %i.fas.fa-edit
            Edit Car Details
          = link_to vendors_cars_path, class: 'w-full bg-gray-50 hover:bg-gray-100 text-gray-700 font-medium px-4 py-3 rounded-lg transition flex items-center justify-center gap-2' do
            %i.fas.fa-arrow-left
            Back to Cars

      / Mulkiya Card
      .bg-white.rounded-xl.shadow-lg.p-6
        %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
          %i.fas.fa-file-alt{style: 'color: #3a6363'}
          Mulkiya
        - if @car.mulkiya.attached?
          .flex.items-center.gap-4
            .w-32.h-24.rounded-lg.overflow-hidden.bg-gray-50.flex.items-center.justify-center.border
              - content_type = @car.mulkiya.content_type.to_s
              - if content_type.start_with?("image/")
                = image_tag url_for(@car.mulkiya.variant(resize_to_fill: [128, 96])), class: 'w-full h-full object-cover'
              - elsif content_type == 'application/pdf'
                %embed{ src: url_for(@car.mulkiya), type: 'application/pdf', class: 'w-full h-full' }
              - else
                %i.fas.fa-file-alt.text-3xl.text-gray-400
            .flex
              = link_to 'View/Download', url_for(@car.mulkiya), target: '_blank', class: 'text-blue-600 underline'
        - else
          %p.text-gray-500 No mulkiya uploaded yet.

  / Car Overview Section (from public show)
  .mt-8
    .bg-white.rounded-xl.shadow-lg.p-8
      %h2.text-2xl.font-bold.mb-6{style: 'color: #2d4f4f'} Car Overview
      .grid.grid-cols-2.md:grid-cols-3.lg:grid-cols-4.gap-6
        .flex.items-center.space-x-3
          %i.fas.fa-car.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Body Type
            %p.font-medium= @car.category || 'Sedan'
        .flex.items-center.space-x-3
          %i.fas.fa-calendar.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Model
            %p.font-medium= @car.year || '2021'
        .flex.items-center.space-x-3
          %i.fas.fa-palette.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Colour
            %p.font-medium= @car.color || 'Black'
        .flex.items-center.space-x-3
          %i.fas.fa-gas-pump.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Fuel
            %p.font-medium= @car.fuel_type || 'Petrol'
        .flex.items-center.space-x-3
          %i.fas.fa-tachometer-alt.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Mileage
            %p.font-medium= @car.mileage || '50,000'
        .flex.items-center.space-x-3
          %i.fas.fa-cogs.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Transmission
            %p.font-medium= @car.transmission || 'Auto'
        .flex.items-center.space-x-3
          %i.fas.fa-users.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Seating Capacity
            %p.font-medium= "#{@car.seats || 5} passengers"
        .flex.items-center.space-x-3
          %i.fas.fa-engine.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Engine CC
            %p.font-medium= @car.engine_size || '2.0L'

  / Requirements Section
  .mt-8
    .bg-white.rounded-xl.shadow-lg.p-8
      %h2.text-2xl.font-bold.mb-6{style: 'color: #2d4f4f'} Requirements To Rent This Car
      .space-y-3.text-gray-700
        %p • Valid UAE driving license
        %p • Emirates ID or Passport
        %p • Security deposit required
        %p • Minimum age: 21 years

  / Bookings Section
  .mt-8
    .bg-white.rounded-xl.shadow-lg.p-6
      %h2.text-xl.font-bold.mb-6.flex.items-center.gap-2{style: 'color:#2d4f4f'}
        %i.fas.fa-calendar-alt{style: 'color: #3a6363'}
        Bookings for this Car
      
      - if @bookings.any?
        .overflow-x-auto
          %table.min-w-full
            %thead
              %tr.border-b.border-gray-200
                %th.px-4.py-3.text-left.text-xs.font-semibold.text-gray-600.uppercase.tracking-wider User
                %th.px-4.py-3.text-left.text-xs.font-semibold.text-gray-600.uppercase.tracking-wider Start Date
                %th.px-4.py-3.text-left.text-xs.font-semibold.text-gray-600.uppercase.tracking-wider End Date
                %th.px-4.py-3.text-left.text-xs.font-semibold.text-gray-600.uppercase.tracking-wider Status
                %th.px-4.py-3.text-left.text-xs.font-semibold.text-gray-600.uppercase.tracking-wider Payment
            %tbody.divide-y.divide-gray-200
              - @bookings.each do |booking|
                %tr.hover:bg-gray-50.transition
                  %td.px-4.py-4.whitespace-nowrap
                    .flex.flex-col
                      %span.font-medium.text-gray-900= booking.user&.full_name || 'N/A'
                      %span.text-sm.text-gray-500= booking.user&.email
                  %td.px-4.py-4.whitespace-nowrap.text-gray-900= booking.start_date.strftime('%b %d, %Y')
                  %td.px-4.py-4.whitespace-nowrap.text-gray-900= booking.end_date.strftime('%b %d, %Y')
                  %td.px-4.py-4.whitespace-nowrap
                    - status_classes = {'Pending' => 'bg-yellow-100 text-yellow-700', 'Confirmed' => 'bg-green-100 text-green-700', 'Cancelled' => 'bg-red-100 text-red-700'}
                    %span.inline-block.rounded-full.text-xs.font-semibold.px-3.py-1{class: status_classes[booking.status] || 'bg-gray-100 text-gray-700'}= booking.status
                  %td.px-4.py-4.whitespace-nowrap
                    - if booking.payment_processed?
                      %span.inline-block.bg-green-100.text-green-700.px-3.py-1.rounded-full.text-xs.font-semibold Paid
                    - else
                      %span.inline-block.bg-yellow-100.text-yellow-700.px-3.py-1.rounded-full.text-xs.font-semibold Pending
      - else
        .text-center.py-8
          %i.fas.fa-calendar-times.text-4xl.text-gray-300.mb-4
          %p.text-gray-500.text-lg No bookings for this car yet.
          %p.text-gray-400.text-sm This car is available for new bookings.

  / Right-side Drawer for policy info
  #policyDrawer.fixed.top-0.right-0.h-full.w-96.bg-white.shadow-2xl.transform.translate-x-full.transition-transform.duration-300.z-50{ 'aria-hidden' => 'true' }
    .flex.items-center.justify-between.px-5.py-4.border-b
      %h5#policyDrawerTitle.text-lg.font-bold{style: 'color:#2d4f4f'} Policy Details
      %button#closePolicyDrawer.text-gray-400.hover:text-gray-600{ type: 'button', 'aria-label' => 'Close' }
        %i.fas.fa-times
    .p-5.overflow-y-auto.h-full
      #policyDrawerContent.text-gray-700
        / Content populated by JavaScript

:javascript
  // Initialize Swiper with better timing and Turbo support
  function initializeSwiper() {
    // Wait for Swiper to be available
    if (typeof Swiper === 'undefined') {
      setTimeout(initializeSwiper, 50);
      return;
    }
    
    const swiperContainer = document.querySelector('.swiper-container');
    if (!swiperContainer) {
      return;
    }
    
    // Destroy existing swiper instance if it exists
    if (swiperContainer.swiper) {
      swiperContainer.swiper.destroy(true, true);
    }
    
    const swiper = new Swiper('.swiper-container', {
      loop: true,
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
        dynamicBullets: true,
      },
      slidesPerView: 1,
      spaceBetween: 0,
      centeredSlides: true,
      autoHeight: true,
      effect: 'fade',
      fadeEffect: {
        crossFade: true
      },
      on: {
        slideChange: function() {
          // Update image counter
          const currentSlide = this.realIndex + 1;
          const totalSlides = this.slides.length;
          const counter = document.querySelector('.current-slide');
          if (counter) {
            counter.textContent = currentSlide;
          }
        }
      }
    });
  }

  // Policy Drawer content (Turbo-friendly, delegated listeners)
  (function() {
    if (window._policyDrawerInit) return; // avoid duplicate bindings
    window._policyDrawerInit = true;

    function getPolicyContent() {
      return {
        mileage: {
          title: 'Mileage Policy',
          content: 'This rental includes limited mileage. Additional charges apply for exceeding the daily mileage limit of ' + (#{@car.daily_milleage || 200}) + ' km per day. Extra mileage is charged at AED 1 per kilometer.'
        },
        fuel: {
          title: 'Fuel Policy',
          content: 'The vehicle will be provided with a full tank of fuel. You are required to return the vehicle with the same fuel level. If returned with less fuel, you will be charged for refueling at current market rates plus a service fee.'
        },
        deposit: {
          title: 'Deposit Policy',
          content: 'A security deposit of AED 1500 is required and will be blocked on your credit card. This deposit covers any potential damages, traffic fines, or additional charges. The deposit will be released within 7-10 business days after the rental return, subject to no claims.'
        },
        rental: {
          title: 'Rental Policy',
          content: 'Minimum rental age is 21 years. A valid UAE driving license is required for UAE residents, or an International Driving Permit for tourists. The renter is responsible for all traffic fines incurred during the rental period. Vehicle must be returned to the same location unless prior arrangements are made.'
        },
        min_days: {
          title: 'Minimum Rental Duration',
          content: 'The minimum rental period for this vehicle is 5 days. Shorter durations are not eligible for booking and pricing is calculated on a per-day basis.'
        }
      };
    }

    function openPolicyDrawer(title, content) {
      const drawer = document.getElementById('policyDrawer');
      const titleEl = document.getElementById('policyDrawerTitle');
      const contentEl = document.getElementById('policyDrawerContent');
      if (!drawer || !titleEl || !contentEl) return;
      titleEl.textContent = title;
      contentEl.innerHTML = '<p>' + content + '</p>';
      drawer.setAttribute('aria-hidden', 'false');
      drawer.classList.remove('translate-x-full');
    }

    function closePolicyDrawer() {
      const drawer = document.getElementById('policyDrawer');
      if (!drawer) return;
      drawer.setAttribute('aria-hidden', 'true');
      drawer.classList.add('translate-x-full');
    }

    function bindPolicyDrawer() {
      const closeBtn = document.getElementById('closePolicyDrawer');
      if (closeBtn && !closeBtn._bound) {
        closeBtn.addEventListener('click', closePolicyDrawer);
        closeBtn._bound = true;
      }

      document.addEventListener('click', function(e) {
        const trigger = e.target.closest && e.target.closest('[data-policy]');
        if (!trigger) return;
        const type = trigger.getAttribute('data-policy');
        const policy = getPolicyContent()[type];
        if (!policy) return;
        e.preventDefault();
        openPolicyDrawer(policy.title, policy.content);
      });

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closePolicyDrawer();
        }
      });
    }

    function init() {
      bindPolicyDrawer();
    }

    document.addEventListener('DOMContentLoaded', init);
    document.addEventListener('turbo:load', init);
    document.addEventListener('turbo:render', init);
    if (document.readyState !== 'loading') {
      setTimeout(init, 0);
    }
  })();

  // Multiple initialization triggers for different scenarios
  document.addEventListener('DOMContentLoaded', initializeSwiper);
  document.addEventListener('turbo:load', initializeSwiper);
  document.addEventListener('turbo:render', initializeSwiper);
  
  // Immediate initialization if DOM is already ready
  if (document.readyState !== 'loading') {
    setTimeout(initializeSwiper, 100);
  }

