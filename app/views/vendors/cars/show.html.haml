.container.mx-auto.max-w-7xl.p-6
  = render partial: "vendors/navbar"
  
  / Hero Section with Car Images
  .bg-white.rounded-2xl.shadow-xl.overflow-hidden.mb-8
    .relative.h-96.bg-gradient-to-r.from-blue-50.to-indigo-50
      = car_image_slider(@car, height: 'h-96', show_counter: true, show_navigation: true, show_pagination: true)
    
    / Car Title and Actions
    .p-8
      .flex.flex-col.md:flex-row.md:items-center.md:justify-between.gap-4
        .flex-1
          %h1.text-4xl.font-extrabold.mb-2{style: 'color: #2d4f4f'}= "#{@car.brand} #{@car.model}"
          .flex.items-center.gap-4.mb-4
            %span.text-lg.text-gray-600= @car.year
            %span.text-lg.text-gray-600= @car.color
            %span.text-lg.text-gray-600= @car.category.presence || '—'
          .flex.items-center.gap-4
            - status_classes = {'available' => 'bg-green-100 text-green-700', 'rented' => 'bg-red-100 text-red-700', 'maintenance' => 'bg-yellow-100 text-yellow-700'}
            %span.inline-block.rounded-full.text-sm.font-semibold.px-4.py-2{class: status_classes[@car.status] || 'bg-blue-100 text-blue-700'}= @car.status.titleize
            %span.text-2xl.font-bold{style: 'color: #3a6363'}= @car.daily_price ? number_to_currency(@car.daily_price) : 'N/A'
            %span.text-gray-500   /day
            %span.text-2xl.font-bold{style: 'color: #3a6363'}= @car.weekly_price ? number_to_currency(@car.weekly_price) : 'N/A'
            %span.text-gray-500 /week
            %span.text-2xl.font-bold{style: 'color: #3a6363'}= @car.monthly_price ? number_to_currency(@car.monthly_price) : 'N/A'
            %span.text-gray-500 /month
        .flex.gap-3
          = link_to edit_vendors_car_path(@car), class: 'text-white font-semibold px-6 py-3 rounded-lg transition flex items-center gap-2', style: 'background-color:#3a6363' do
            %i.fas.fa-edit
            Edit Car
          = link_to vendors_car_path(@car), method: :delete, data: { confirm: 'Are you sure you want to delete this car?' }, class: 'bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-3 rounded-lg transition flex items-center gap-2' do
            %i.fas.fa-trash
            Delete

  / Main Content Grid
  .grid.grid-cols-1.lg:grid-cols-3.gap-8
    / Left Column - Car Details
    .lg:col-span-2.space-y-6
      / Rental Terms (from public show)
      .bg-white.rounded-xl.shadow-lg
        .px-6.py-4.border-b
          %h3.font-semibold.text-gray-900 Rental Terms
        .p-6
          .grid.grid-cols-1.sm:grid-cols-2.gap-x-10.gap-y-5.place-items-center.text-center
            .flex.items-center.justify-center.gap-3
              %i.fas.fa-tachometer-alt.text-xl.text-gray-700
              %span.text-gray-800 Mileage Policy
              %button.text-gray-400.hover:text-gray-600{ "data-policy" => "mileage" }
                %i.fas.fa-info-circle
            .flex.items-center.justify-center.gap-3
              %i.fas.fa-gas-pump.text-xl.text-gray-700
              %span.text-gray-800 Fuel Policy
              %button.text-gray-400.hover:text-gray-600{ "data-policy" => "fuel" }
                %i.fas.fa-info-circle
            .flex.items-center.justify-center.gap-3
              %i.fas.fa-file-alt.text-xl.text-gray-700
              %span.text-gray-800 Rental Policy
              %button.text-gray-400.hover:text-gray-600{ "data-policy" => "rental" }
                %i.fas.fa-info-circle

      / Insurance Highlights
      .bg-white.rounded-xl.shadow-lg.mb-6
        .p-6
          .flex.flex-col.sm:flex-row.items-center.justify-center.gap-10.text-center
            .flex.items-center.gap-3
              %span.inline-flex.items-center.justify-center.w-6.h-6.rounded-full.bg-green-500.text-white
                %i.fas.fa-check.text-xs
              %span.text-gray-800 Minimum 5 days rental
            .flex.items-center.gap-3
              %span.relative.group.inline-flex.items-center.justify-center.w-6.h-6.rounded-full.bg-green-500.text-white.cursor-pointer{ 'aria-describedby' => 'insurance-tooltip' }
                %i.fas.fa-check.text-xs
                %span#insurance-tooltip{ class: 'absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-64 rounded-lg bg-[#3A6363] text-white text-sm p-2 shadow-lg hidden group-hover:block whitespace-normal break-words z-10', role: 'tooltip' }
                  = @car.insurance_policy.present? ? @car.insurance_policy : 'No insurance policy provided'
              %span.text-gray-800 Insurance included

      / Basic Information Card
      .bg-white.rounded-xl.shadow-lg.p-6
        %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
          %i.fas.fa-info-circle{style: 'color: #3a6363'}
          Basic Information
        .grid.grid-cols-1.md:grid-cols-2.gap-4
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Model
            %span.text-gray-900= @car.model
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Brand
            %span.text-gray-900= @car.brand
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Year
            %span.text-gray-900= @car.year
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Color
            %span.text-gray-900= @car.color
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Category
            %span.text-gray-900= @car.category.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Daily Price
            %span.text-gray-900= @car.daily_price ? number_to_currency(@car.daily_price) : 'N/A'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Weekly Price
            %span.text-gray-900= @car.weekly_price ? number_to_currency(@car.weekly_price) : 'N/A'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Monthly Price
            %span.text-gray-900= @car.monthly_price ? number_to_currency(@car.monthly_price) : 'N/A'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Additional Mileage Charge
            %span.text-gray-900= @car.additional_mileage_charge ? number_to_currency(@car.additional_mileage_charge) : 'N/A'

      / Specifications Card
      .bg-white.rounded-xl.shadow-lg.p-6
        %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
          %i.fas.fa-cogs{style: 'color: #3a6363'}
          Specifications
        .grid.grid-cols-1.md:grid-cols-2.gap-4
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Transmission
            %span.text-gray-900= @car.transmission.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Fuel Type
            %span.text-gray-900= @car.fuel_type.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Seats
            %span.text-gray-900= @car.seats.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Daily Mileage
            %span.text-gray-900= @car.daily_milleage.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Weekly Mileage
            %span.text-gray-900= @car.weekly_milleage.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Monthly Mileage
            %span.text-gray-900= @car.monthly_milleage.presence || '—'
          .flex.justify-between.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Engine Size
            %span.text-gray-900= @car.engine_size.presence || '—'

      / Features & Specs Section
      .bg-white.rounded-xl.shadow-lg.p-6
        %h2.text-2xl.font-bold.mb-6{style: 'color: #2d4f4f'} FEATURES & SPECS
        
        - if @car.features.any?
          .relative
            #featuresGrid.grid.grid-cols-1.sm:grid-cols-2.md:grid-cols-3.lg:grid-cols-4.gap-4
              - @car.features.each_with_index do |feature, index|
                .flex.items-center.feature-item{class: index >= 12 ? 'hidden' : '', 'data-index': index}
                  %i.fas.fa-check-circle.mr-3{class: feature.common ? 'text-green-500' : 'text-purple-500'}
                  %span.text-gray-700
                    = feature.name
                    - unless feature.common
                      %span.ml-1.text-xs.text-purple-600 ⭐
            
            - if @car.features.count > 12
              .mt-6.text-center
                %button#showMoreFeaturesBtn.px-6.py-3.text-white.rounded-lg.font-semibold.transition-all.duration-200.shadow-md.hover:shadow-lg.flex.items-center.justify-center.mx-auto.gap-2{style: 'background-color: #3a6363'}
                  %span#btnText Show More Features
                  %i.fas.fa-chevron-down#btnIcon
        - else
          .text-center.py-8.text-gray-500
            %i.fas.fa-info-circle.text-3xl.mb-3
            %p No features available for this vehicle

      / Description Card
      - if @car.description.present?
        .bg-white.rounded-xl.shadow-lg.p-6
          %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
            %i.fas.fa-align-left{style: 'color: #3a6363'}
            Description & Highlights
          %p.text-gray-700.leading-relaxed= @car.description

    / Right Column - Sidebar
    .space-y-6
      / Car Stats Card
      .bg-white.rounded-xl.shadow-lg.p-6
        %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
          %i.fas.fa-chart-bar{style: 'color: #3a6363'}
          Car Stats
        .space-y-4
          .flex.justify-between.items-center.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Created
            %span.text-gray-900= @car.created_at.strftime('%b %d, %Y')
          .flex.justify-between.items-center.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Updated
            %span.text-gray-900= @car.updated_at.strftime('%b %d, %Y')
          .flex.justify-between.items-center.py-2.border-b.border-gray-100
            %span.font-medium.text-gray-600 Total Bookings
            %span.text-gray-900= @bookings.count
          .flex.justify-between.items-center.py-2
            %span.font-medium.text-gray-600 Active Bookings
            %span.text-gray-900= @bookings.where(status: 'Pending').count

      / Quick Actions Card
      .bg-white.rounded-xl.shadow-lg.p-6
        %h2.text-xl.font-bold.mb-4.flex.items-center.gap-2{style: 'color:#2d4f4f'}
          %i.fas.fa-bolt{style: 'color: #3a6363'}
          Quick Actions
        .space-y-3
          = link_to edit_vendors_car_path(@car), class: 'w-full text-white font-medium px-4 py-3 rounded-lg transition flex items-center justify-center gap-2', style: 'background-color:#3A6363' do
            %i.fas.fa-edit
            Edit Car Details
          = link_to vendors_cars_path, class: 'w-full bg-gray-50 hover:bg-gray-100 text-gray-700 font-medium px-4 py-3 rounded-lg transition flex items-center justify-center gap-2' do
            %i.fas.fa-arrow-left
            Back to Cars

      / Enhanced Mulkiya Card
      .bg-white.rounded-2xl.shadow-xl.border.border-gray-100.overflow-hidden.transition-all.duration-300
        / Header Section
        .bg-gradient-to-r.from-slate-50.to-gray-50.px-6.py-4.border-b.border-gray-100
          %h2.text-xl.font-bold.flex.items-center.gap-3{style: 'color:#3A6363'}
            .p-2.rounded-lg{style: 'background-color:#E6F0F0'}
              %i.fas.fa-id-card{style: 'color:#3A6363'}
            Mulkiya

        / Content Section  
        .p-6
          - if @car.car_document.present? && @car.car_document.mulkiya.attached?
            .space-y-4
              / Document Preview & Actions Row
              .flex.flex-col.lg:flex-row.gap-4.items-start
                / Document Preview
                .flex-shrink-0.w-full.lg:w-40
                  .w-full.lg:w-40.h-32.rounded-xl.overflow-hidden.bg-gradient-to-br.from-gray-50.to-gray-100.border-2.border-dashed.flex.items-center.justify-center.relative.group.transition-all.duration-300.hover:shadow-lg{style: 'border-color:#3A6363'}
                    - content_type = @car.car_document.mulkiya.content_type.to_s
                    - if content_type.start_with?("image/")
                      = image_tag url_for(@car.car_document.mulkiya.variant(resize_to_fill: [160, 128])), class: 'w-full h-full object-cover transition-transform duration-300 group-hover:scale-110'
                      .absolute.inset-0.bg-black.bg-opacity-0.group-hover:bg-opacity-20.transition-all.duration-300.flex.items-center.justify-center
                        %i.fas.fa-search-plus.text-white.opacity-0.group-hover:opacity-100.text-xl
                    - elsif content_type == 'application/pdf'
                      .text-center.space-y-2
                        %i.fas.fa-file-pdf.text-4xl.text-red-500
                        %span.text-xs.font-medium.text-gray-600 PDF Document
                    - else
                      .text-center.space-y-2
                        %i.fas.fa-file-alt.text-4xl.text-gray-400
                        %span.text-xs.font-medium.text-gray-600 Document
          
                / Document Info & Actions
                .flex-1.min-w-0.space-y-4
            
                  / Action Buttons & Status
                  .flex.flex-col.sm:flex-row.gap-3.items-start.sm:items-center.justify-between.flex-wrap
                    / Download Button
                    = link_to url_for(@car.car_document.mulkiya), target: '_blank', class: 'inline-flex items-center gap-1 px-3 py-2 text-white text-sm font-medium rounded-md transition-all duration-200 shadow hover:shadow-md whitespace-nowrap', style: 'background-color:#3A6363; hover:background-color:#2d4f4f' do
                      %i.fas.fa-download
                      %span View & Download
                
                    / Status Badge
                    - status = @car.car_document.document_status
                    - case status
                    - when 'approved'
                      - badge_classes = 'bg-emerald-50 text-emerald-700 border-emerald-200'
                      - icon_class = 'fas fa-check-circle text-emerald-600'
                    - when 'rejected'
                      - badge_classes = 'bg-red-50 text-red-700 border-red-200'
                      - icon_class = 'fas fa-times-circle text-red-600'
                    - when 'pending'
                      - badge_classes = 'bg-amber-50 text-amber-700 border-amber-200'
                      - icon_class = 'fas fa-clock text-amber-600'
                    - else
                      - badge_classes = 'bg-gray-50 text-gray-700 border-gray-200'
                      - icon_class = 'fas fa-question-circle text-gray-600'
                
                    .inline-flex.items-center.gap-2.px-3.py-2.rounded-lg.text-sm.font-semibold.border-2.transition-all.duration-200.whitespace-nowrap{class: badge_classes}
                      %i{class: icon_class}
                      %span= status.to_s.titleize
        
          - else
            / Empty State
            .text-center.py-12.space-y-6
              .w-24.h-24.mx-auto.rounded-full.flex.items-center.justify-center{style: 'background-color:#E6F0F0'}
                %i.fas.fa-file-plus.text-3xl{style: 'color:#3A6363'}
              .space-y-2
                %h3.text-lg.font-semibold.text-gray-800 No Mulkiya Document
                %p.max-w-md.mx-auto.leading-relaxed.break-words{style: 'color:#3A6363'}
                  Upload Mulkiya document to complete your car profile and enable verification.

  / Car Overview Section (from public show)
  .mt-8
    .bg-white.rounded-xl.shadow-lg.p-8
      %h2.text-2xl.font-bold.mb-6{style: 'color: #2d4f4f'} Car Overview
      .grid.grid-cols-2.md:grid-cols-3.lg:grid-cols-4.gap-6
        .flex.items-center.space-x-3
          %i.fas.fa-car.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Body Type
            %p.font-medium= @car.category || 'Sedan'
        .flex.items-center.space-x-3
          %i.fas.fa-calendar.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Model
            %p.font-medium= @car.year || '2021'
        .flex.items-center.space-x-3
          %i.fas.fa-palette.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Colour
            %p.font-medium= @car.color || 'Black'
        .flex.items-center.space-x-3
          %i.fas.fa-gas-pump.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Fuel
            %p.font-medium= @car.fuel_type || 'Petrol'
        .flex.items-center.space-x-3
          %i.fas.fa-cogs.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Transmission
            %p.font-medium= @car.transmission || 'Auto'
        .flex.items-center.space-x-3
          %i.fas.fa-users.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Seating Capacity
            %p.font-medium= "#{@car.seats || 5} passengers"
        .flex.items-center.space-x-3
          %i.fas.fa-engine.text-gray-400.w-5
          .div
            %span.text-sm.text-gray-500 Engine CC
            %p.font-medium= @car.engine_size || '2.0L'

  / Required Document Section
  .mt-8
    .mx-auto
      .bg-white.rounded-2xl.shadow-lg.p-8

        / Required Documents Section
        .mb-8
          .text-xl.font-bold.text-gray-800.mb-4 ✅ Required Documents
          %ul.text-gray-700.text-left.max-w-2xl.mx-10.list-disc.pl-6.space-y-2
            %li
              %strong Tourists / Non-Residents:
              | Passport copy, home country license, International Driving Permit (if required), Visa Copy.
            %li
              %strong Residents:
              | Emirates ID, UAE driving license.
            %li
              %strong GCC Nationals:
              | GCC ID or Passport, GCC driving license.

        / Before Delivery Section
        .mb-8
          .text-xl.font-bold.text-gray-800.mb-4 ✅ Before Delivery
          %ul.text-gray-700.text-left.max-w-2xl.mx-10.list-disc.pl-6.space-y-2
            %li Customers must present the receipt received during booking with Wheelsonrent at the time of car collection.
            %li Collect payment receipt.
            %li Collect a copy of the rental agreement.

        / Note Section
        .mb-8
          .text-xl.font-bold.text-gray-800.mb-4 ⚠️ Note
          %ul.text-gray-700.text-left.max-w-2xl.mx-10.list-disc.pl-6.space-y-2
            %li Wheelsonrent platform only displays cars and manages reservations.
            %li Wheelsonrent bears no responsibility for rental payments made between the customer and the car rental company.
        
        / Additional Note
        .mt-6
          %p.text-gray-600.italic.text-left.max-w-2xl.mx-10
            * Customers must present the booking confirmation received during booking with Wheelsonrent at the time of car collection.

  / Bookings Section
  .mt-8
    .bg-white.rounded-xl.shadow-lg.p-6
      %h2.text-xl.font-bold.mb-6.flex.items-center.gap-2{style: 'color:#2d4f4f'}
        %i.fas.fa-calendar-alt{style: 'color: #3a6363'}
        Bookings for this Car
      
      - if @bookings.any?
        .overflow-x-auto
          %table.min-w-full
            %thead
              %tr.border-b.border-gray-200
                %th.px-4.py-3.text-left.text-xs.font-semibold.text-gray-600.uppercase.tracking-wider User
                %th.px-4.py-3.text-left.text-xs.font-semibold.text-gray-600.uppercase.tracking-wider Start Date
                %th.px-4.py-3.text-left.text-xs.font-semibold.text-gray-600.uppercase.tracking-wider End Date
                %th.px-4.py-3.text-left.text-xs.font-semibold.text-gray-600.uppercase.tracking-wider Status
                %th.px-4.py-3.text-left.text-xs.font-semibold.text-gray-600.uppercase.tracking-wider Payment
            %tbody.divide-y.divide-gray-200
              - @bookings.each do |booking|
                %tr.hover:bg-gray-50.transition
                  %td.px-4.py-4.whitespace-nowrap
                    .flex.flex-col
                      %span.font-medium.text-gray-900= booking.user&.full_name || 'N/A'
                      %span.text-sm.text-gray-500= booking.user&.email
                  %td.px-4.py-4.whitespace-nowrap.text-gray-900= booking.start_date.strftime('%b %d, %Y')
                  %td.px-4.py-4.whitespace-nowrap.text-gray-900= booking.end_date.strftime('%b %d, %Y')
                  %td.px-4.py-4.whitespace-nowrap
                    - status_classes = {'Pending' => 'bg-yellow-100 text-yellow-700', 'Confirmed' => 'bg-green-100 text-green-700', 'Cancelled' => 'bg-red-100 text-red-700'}
                    %span.inline-block.rounded-full.text-xs.font-semibold.px-3.py-1{class: status_classes[booking.status] || 'bg-gray-100 text-gray-700'}= booking.status
                  %td.px-4.py-4.whitespace-nowrap
                    - if booking.payment_processed?
                      %span.inline-block.bg-green-100.text-green-700.px-3.py-1.rounded-full.text-xs.font-semibold Paid
                    - else
                      %span.inline-block.bg-yellow-100.text-yellow-700.px-3.py-1.rounded-full.text-xs.font-semibold Pending
      - else
        .text-center.py-8
          %i.fas.fa-calendar-times.text-4xl.text-gray-300.mb-4
          %p.text-gray-500.text-lg No bookings for this car yet.
          %p.text-gray-400.text-sm This car is available for new bookings.

  / Right-side Drawer for policy info
  #policyDrawer.fixed.top-0.right-0.h-full.w-96.bg-white.shadow-2xl.transform.translate-x-full.transition-transform.duration-300.z-50{ 'aria-hidden' => 'true' }
    .flex.items-center.justify-between.px-5.py-4.border-b
      %h5#policyDrawerTitle.text-lg.font-bold{style: 'color:#2d4f4f'} Policy Details
      %button#closePolicyDrawer.text-gray-400.hover:text-gray-600{ type: 'button', 'aria-label' => 'Close' }
        %i.fas.fa-times
    .p-5.overflow-y-auto.h-full
      #policyDrawerContent.text-gray-700
        / Content populated by JavaScript

:javascript
  // Initialize Swiper with better timing and Turbo support
  function initializeSwiper() {
    // Wait for Swiper to be available
    if (typeof Swiper === 'undefined') {
      setTimeout(initializeSwiper, 50);
      return;
    }
    
    const swiperContainer = document.querySelector('.swiper-container');
    if (!swiperContainer) {
      return;
    }
    
    // Destroy existing swiper instance if it exists
    if (swiperContainer.swiper) {
      swiperContainer.swiper.destroy(true, true);
    }
    
    const swiper = new Swiper('.swiper-container', {
      loop: true,
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
        dynamicBullets: true,
      },
      slidesPerView: 1,
      spaceBetween: 0,
      centeredSlides: true,
      autoHeight: true,
      effect: 'fade',
      fadeEffect: {
        crossFade: true
      },
      on: {
        slideChange: function() {
          // Update image counter
          const currentSlide = this.realIndex + 1;
          const totalSlides = this.slides.length;
          const counter = document.querySelector('.current-slide');
          if (counter) {
            counter.textContent = currentSlide;
          }
        }
      }
    });
  }

  // Show More Features functionality
  function initializeFeaturesToggle() {
    const showMoreBtn = document.getElementById('showMoreFeaturesBtn');
    const btnText = document.getElementById('btnText');
    const btnIcon = document.getElementById('btnIcon');
    
    if (!showMoreBtn) return; // Exit if button doesn't exist
    
    let isExpanded = false;
    
    // Remove any existing event listeners to avoid duplicates
    const newBtn = showMoreBtn.cloneNode(true);
    showMoreBtn.parentNode.replaceChild(newBtn, showMoreBtn);
    
    newBtn.addEventListener('click', function() {
      const allFeatures = document.querySelectorAll('.feature-item');
      const newBtnText = this.querySelector('#btnText');
      const newBtnIcon = this.querySelector('#btnIcon');
      
      if (!isExpanded) {
        // Show all features
        allFeatures.forEach(function(feature) {
          feature.classList.remove('hidden');
        });
        if (newBtnText) newBtnText.textContent = 'Show Less Features';
        if (newBtnIcon) {
          newBtnIcon.classList.remove('fa-chevron-down');
          newBtnIcon.classList.add('fa-chevron-up');
        }
        isExpanded = true;
      } else {
        // Hide features after index 11
        allFeatures.forEach(function(feature) {
          const index = parseInt(feature.getAttribute('data-index'));
          if (index >= 12) {
            feature.classList.add('hidden');
          }
        });
        if (newBtnText) newBtnText.textContent = 'Show More Features';
        if (newBtnIcon) {
          newBtnIcon.classList.remove('fa-chevron-up');
          newBtnIcon.classList.add('fa-chevron-down');
        }
        isExpanded = false;
        
        // Scroll back to features section
        const featuresGrid = document.querySelector('#featuresGrid');
        if (featuresGrid) {
          featuresGrid.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }
    });
  }

  // Policy Drawer content (Turbo-friendly, delegated listeners)
  (function() {
    if (window._policyDrawerInit) return; // avoid duplicate bindings
    window._policyDrawerInit = true;

    function getPolicyContent() {
      return {
        mileage: {
          title: 'Mileage Policy',
          content: 'Most rentals come with a daily mileage limit (200-250 km per day). Exceeding this limit will result in additional charges of AED 0.50 per extra kilometer. Some rental companies also offer unlimited mileage or extra mileage packages.'
        },
        fuel: {
          title: 'Fuel Policy',
          content: 'The vehicle will be provided with a full tank of fuel. You are required to return the vehicle with the same fuel level. If returned with less fuel, you will be charged for refueling at current market rates plus a service fee.'
        },
        rental: {
          title: 'Rental Policy',
          content: "Renters must be at least 21 years old. UAE residents need a valid UAE driving license, and tourists must provide an International Driving Permit. Any traffic fines incurred during the rental period are the renter's responsibility. Vehicles should be returned to the original pickup location unless alternative arrangements have been approved in advance."
        },
        min_days: {
          title: 'Minimum Rental Duration',
          content: 'The minimum rental period for this vehicle is 5 days. Shorter durations are not eligible for booking and pricing is calculated on a per-day basis.'
        }
      };
    }

    function openPolicyDrawer(title, content) {
      const drawer = document.getElementById('policyDrawer');
      const titleEl = document.getElementById('policyDrawerTitle');
      const contentEl = document.getElementById('policyDrawerContent');
      if (!drawer || !titleEl || !contentEl) return;
      titleEl.textContent = title;
      contentEl.innerHTML = '<p>' + content + '</p>';
      drawer.setAttribute('aria-hidden', 'false');
      drawer.classList.remove('translate-x-full');
    }

    function closePolicyDrawer() {
      const drawer = document.getElementById('policyDrawer');
      if (!drawer) return;
      drawer.setAttribute('aria-hidden', 'true');
      drawer.classList.add('translate-x-full');
    }

    function bindPolicyDrawer() {
      const closeBtn = document.getElementById('closePolicyDrawer');
      if (closeBtn && !closeBtn._bound) {
        closeBtn.addEventListener('click', closePolicyDrawer);
        closeBtn._bound = true;
      }

      document.addEventListener('click', function(e) {
        const trigger = e.target.closest && e.target.closest('[data-policy]');
        if (!trigger) return;
        const type = trigger.getAttribute('data-policy');
        const policy = getPolicyContent()[type];
        if (!policy) return;
        e.preventDefault();
        openPolicyDrawer(policy.title, policy.content);
      });

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closePolicyDrawer();
        }
      });
    }

    function init() {
      bindPolicyDrawer();
      initializeFeaturesToggle(); // Initialize features toggle
    }

    document.addEventListener('DOMContentLoaded', init);
    document.addEventListener('turbo:load', init);
    document.addEventListener('turbo:render', init);
    if (document.readyState !== 'loading') {
      setTimeout(init, 0);
    }
  })();

  // Multiple initialization triggers for different scenarios
  document.addEventListener('DOMContentLoaded', function() {
    initializeSwiper();
    initializeFeaturesToggle();
  });
  
  document.addEventListener('turbo:load', function() {
    initializeSwiper();
    initializeFeaturesToggle();
  });
  
  document.addEventListener('turbo:render', function() {
    initializeSwiper();
    initializeFeaturesToggle();
  });
  
  // Immediate initialization if DOM is already ready
  if (document.readyState !== 'loading') {
    setTimeout(function() {
      initializeSwiper();
      initializeFeaturesToggle();
    }, 100);
  }