.container.mx-auto.max-w-7xl.p-6
  = render partial: "vendors/navbar"
  
  .bg-white.rounded-2xl.shadow-xl.p-8
    %h1.text-4xl.font-extrabold.mb-6{style: 'color: #3a6363'} Edit Profile
    %p.text-lg.text-gray-700.mb-8 Update your vendor profile information below.

    / Flash Messages
    -# - if notice
      .mb-6.p-4.bg-green-50.border.border-green-200.rounded-lg
        %p.text-green-700.font-medium= notice
    -# - if alert
      .mb-6.p-4.bg-red-50.border.border-red-200.rounded-lg
        %p.text-red-700.font-medium= alert

    = form_with model: @vendor, local: true, class: 'space-y-8' do |f|
      / Personal Information Section
      %h2.text-xl.font-bold.mb-6{style: 'color: #3a6363'} Personal Information
      .grid.grid-cols-1.md:grid-cols-2.gap-6
        .field.space-y-2
          = f.label :first_name, 'First Name *', class: 'block text-sm font-medium text-gray-700'
          = f.text_field :first_name, required: true, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition', placeholder: 'Enter your first name'
          - if @vendor.errors[:first_name].any?
            %p.text-red-600.text-sm.mt-1= @vendor.errors[:first_name].join(', ')
        
        .field.space-y-2
          = f.label :last_name, 'Last Name *', class: 'block text-sm font-medium text-gray-700'
          = f.text_field :last_name, required: true, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition', placeholder: 'Enter your last name'
          - if @vendor.errors[:last_name].any?
            %p.text-red-600.text-sm.mt-1= @vendor.errors[:last_name].join(', ')
        
        .field.space-y-2
          = f.label :email, 'Email Address *', class: 'block text-sm font-medium text-gray-700'
          = f.email_field :email, required: true, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition', placeholder: 'your.email@example.com'
          - if @vendor.errors[:email].any?
            %p.text-red-600.text-sm.mt-1= @vendor.errors[:email].join(', ')

      %h2.text-xl.font-bold.mb-6{style: 'color: #3a6363'} Contact Information
      .grid.grid-cols-1.md:grid-cols-2.gap-6
        .field.space-y-2
          = f.label :phone, 'Phone Number', class: 'block text-sm font-medium text-gray-700'
          .relative
            .absolute.inset-y-0.left-0.pl-4.flex.items-center.pointer-events-none
              %i.fas.fa-phone.text-gray-400
            = f.telephone_field :phone, class: 'w-full pl-12 pr-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition', placeholder: '+971 50 123 4567'
          - if @vendor.errors[:phone].any?
            %p.text-red-600.text-sm.mt-1= @vendor.errors[:phone].join(', ')
        
        .field.space-y-2
          = f.label :whatsapp_number, class: 'block text-sm font-medium text-gray-700' do
            %span WhatsApp Number
            %i.fab.fa-whatsapp.text-green-500.ml-1
          .relative
            .absolute.inset-y-0.left-0.pl-4.flex.items-center.pointer-events-none
              %i.fab.fa-whatsapp.text-green-500.text-lg
            = f.telephone_field :whatsapp_number, class: 'w-full pl-12 pr-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition', placeholder: '+971501234567', pattern: '\+[0-9]{7,15}', title: 'Enter phone number with country code (e.g., +971501234567)'
          %small.text-gray-500.text-xs.mt-1.block Include country code (e.g., +971501234567)
          - if @vendor.errors[:whatsapp_number].any?
            %p.text-red-600.text-sm.mt-1= @vendor.errors[:whatsapp_number].join(', ')

      %h2.text-xl.font-bold.mb-6{style: 'color: #3a6363'} Emirates ID
      .grid.grid-cols-1.md:grid-cols-2.gap-6
        .field.space-y-2
          = f.label :emirates_id, 'Emirates ID *', class: 'block text-sm font-medium text-gray-700'
          = f.text_field :emirates_id, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition', placeholder: '15-digit Emirates ID'
          - if @vendor.errors[:emirates_id].any?
            %p.text-red-600.text-sm.mt-1= @vendor.errors[:emirates_id].join(', ')
        
        .field.space-y-2
          = f.label :emirates_id_expires_on, 'Emirates ID Expiry Date *', class: 'block text-sm font-medium text-gray-700'
          = f.date_field :emirates_id_expires_on, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition'
          - if @vendor.errors[:emirates_id_expires_on].any?
            %p.text-red-600.text-sm.mt-1= @vendor.errors[:emirates_id_expires_on].join(', ')

      / Company Information Section
      %h2.text-xl.font-bold.mb-6.mt-8{style: 'color: #3a6363'} Company Information
      .grid.grid-cols-1.md:grid-cols-2.gap-6
        .field.space-y-2.md:col-span-2
          = f.label :company_name, 'Company Name *', class: 'block text-sm font-medium text-gray-700'
          = f.text_field :company_name, required: true, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition', placeholder: 'Your Company Name'
          - if @vendor.errors[:company_name].any?
            %p.text-red-600.text-sm.mt-1= @vendor.errors[:company_name].join(', ')
        
        .field.space-y-2
          = f.label :website, 'Website', class: 'block text-sm font-medium text-gray-700'
          = f.url_field :website, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition', placeholder: 'https://www.yourcompany.com'
          - if @vendor.errors[:website].any?
            %p.text-red-600.text-sm.mt-1= @vendor.errors[:website].join(', ')
        
        .field.space-y-2
          = f.label :company_logo, 'Company Logo URL', class: 'block text-sm font-medium text-gray-700'
          = f.url_field :company_logo, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition', placeholder: 'https://example.com/logo.png'
          - if @vendor.errors[:company_logo].any?
            %p.text-red-600.text-sm.mt-1= @vendor.errors[:company_logo].join(', ')
        
        .field.space-y-2.md:col-span-2
          = f.label :address, 'Business Address', class: 'block text-sm font-medium text-gray-700'
          = f.text_area :address, rows: 3, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition', placeholder: 'Enter your business address'
          - if @vendor.errors[:address].any?
            %p.text-red-600.text-sm.mt-1= @vendor.errors[:address].join(', ')
        
        -# .field.space-y-2.md:col-span-2
        -#   = f.label :description, 'Company Description', class: 'block text-sm font-medium text-gray-700'
        -#   = f.text_area :description, rows: 4, class: 'w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition', placeholder: 'Tell customers about your company, services, and what makes you unique...'
        -#   - if @vendor.errors[:description].any?
        -#     %p.text-red-600.text-sm.mt-1= @vendor.errors[:description].join(', ')

      / Account Information Section
      %h2.text-xl.font-bold.mb-6.mt-8{style: 'color: #3a6363'} Account Information
      .bg-gray-50.rounded-lg.p-6
        .grid.grid-cols-1.md:grid-cols-2.gap-6
          .field.space-y-2
            %label.block.text-sm.font-medium.text-gray-700 Created
            %p.text-gray-900= @vendor.created_at.strftime('%B %d, %Y')
          
          .field.space-y-2
            %label.block.text-sm.font-medium.text-gray-700 Last Updated
            %p.text-gray-900= @vendor.updated_at.strftime('%B %d, %Y')
          
          .field.space-y-2
            %label.block.text-sm.font-medium.text-gray-700 Total Cars
            %p.text-gray-900= @vendor.cars.count
          
          .field.space-y-2
            %label.block.text-sm.font-medium.text-gray-700 Active Cars
            %p.text-gray-900= @vendor.cars.where(status: 'available').count
      
      / Trade License Section
      %h2.text-lg.font-bold.mb-4.mt-8{style: 'color:#3A6363'} Trade License (PDF or Image) *
      - if @vendor.errors[:trade_license].any?
        .mb-4.p-4.bg-red-50.border.border-red-200.rounded-lg
          %p.text-red-600.font-medium= @vendor.errors[:trade_license].join(', ')

      .mb-2.text-sm.text-gray-600
        %p Upload the trade license card or PDF. Only one file is required.

      .flex.gap-6.mb-6
        .relative.group
          %div.flex.items-center.justify-center.w-32.h-24.bg-blue-50.rounded-xl.shadow.border-2.border-dashed.border-blue-300.group-hover:border-blue-500.transition-all.duration-200{id: 'plus-card-trade-license'}
            %i.fas.fa-plus.text-3xl.text-blue-400{id: 'plus-icon-trade-license'}
            %img.hidden.absolute.inset-0.w-full.h-full.object-cover.rounded-xl{id: 'preview-img-trade-license'}
            %div.hidden.absolute.inset-0.w-full.h-full.flex.items-center.justify-center.rounded-xl{id: 'preview-file-trade-license'}
              %i.fas.fa-file-pdf.text-3xl.text-red-500
            .absolute.-top-2.-right-2.bg-red-500.text-white.text-xs.px-2.py-1.rounded-full.font-bold Required
          = f.file_field :trade_license, id: 'vendor_trade_license', accept: 'application/pdf,image/*,.heic,.heif', class: 'hidden'
        .flex.flex-col.justify-center
          %span.text-sm.text-gray-700.font-medium Selected:
          %span#trade-license-filename.text-sm.text-gray-500 None

      / Action Buttons
      .flex.flex-col.sm:flex-row.gap-4.pt-8
        = f.submit 'Update Profile', class: 'text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 hover:opacity-90', style: 'background-color: #3a6363'
        = link_to 'Cancel', vendor_path(@vendor), class: 'bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 text-center' 

:javascript

  // Trade License upload placeholder behavior
  function initializeLicenseUpload() {
    const fileInput = document.getElementById('vendor_trade_license');
    const previewImg = document.getElementById('preview-img-trade-license');
    const plusIcon = document.getElementById('plus-icon-trade-license');
    const plusCard = document.getElementById('plus-card-trade-license');
    const previewFile = document.getElementById('preview-file-trade-license');
    const fileNameEl = document.getElementById('trade-license-filename');

    if (!(fileInput && previewImg && plusIcon && plusCard && previewFile && fileNameEl)) return;

    // Prevent duplicate bindings across Turbo renders
    if (plusCard.dataset.initialized === 'true') return;
    plusCard.dataset.initialized = 'true';

    const resetPreview = () => {
      previewImg.classList.add('hidden');
      previewFile.classList.add('hidden');
      plusIcon.classList.remove('hidden');
      fileNameEl.textContent = 'None';
      previewImg.src = '';
    };

    plusCard.addEventListener('click', function() {
      fileInput.click();
    });

    fileInput.addEventListener('change', function() {
      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        fileNameEl.textContent = file.name;
        const type = (file.type || '').toLowerCase();

        // If it's an image, try to preview; otherwise show file icon
        if (type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            previewImg.src = ev.target.result;
            previewImg.classList.remove('hidden');
            previewFile.classList.add('hidden');
            plusIcon.classList.add('hidden');
          };
          reader.onerror = function() {
            // Fall back to file icon
            previewImg.classList.add('hidden');
            previewFile.classList.remove('hidden');
            plusIcon.classList.add('hidden');
          };
          reader.readAsDataURL(file);
        } else {
          previewImg.classList.add('hidden');
          previewFile.classList.remove('hidden');
          plusIcon.classList.add('hidden');
        }
      } else {
        resetPreview();
      }
    });
  }

  // Initialize on multiple events to ensure it works
  document.addEventListener('DOMContentLoaded', initializeLicenseUpload);
  document.addEventListener('turbo:load', initializeLicenseUpload);
  document.addEventListener('turbo:render', initializeLicenseUpload);

  // Also initialize immediately if DOM is already ready
  if (document.readyState !== 'loading') {
    setTimeout(initializeLicenseUpload, 120);
  }