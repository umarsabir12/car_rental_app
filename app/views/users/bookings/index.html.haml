.w-full.min-h-screen.bg-gradient-to-br.from-blue-50.to-blue-100
  .px-4.md:px-12.lg:px-32
    
    = render 'shared/user_header'
    
    .mx-auto
      / Back Button
      .mb-6
        = link_to user_home_path, class: 'inline-flex items-center text-blue-600 hover:text-blue-800 font-semibold transition-colors' do
          %i.fas.fa-arrow-left.mr-2
          Back to Dashboard
    
  .bg-white.rounded-3xl.shadow-xl.p-8.mt-0.mx-auto
    / Flash messages
    - if flash[:alert]
      .mb-8.p-4.bg-red-50.border-l-4.border-red-500.rounded-lg.text-red-700.font-medium.flex.items-center
        %i.fas.fa-exclamation-circle.mr-3.text-lg
        = flash[:alert]

    / Header
    .container
      .flex.flex-col.sm:flex-row.items-start.sm:items-center.justify-between.mb-8.gap-4
        %h2.text-2xl.sm:text-3xl.font-bold.text-gray-900.flex.items-center
          %i.fas.fa-calendar-alt.mr-2.sm:mr-4.text-blue-600.text-xl.sm:text-2xl
          - if params[:filter] == 'active'
            Active Bookings
          - elsif params[:filter] == 'cancelled'
            Cancelled Bookings
          - else
            My Bookings
        .flex.items-center.space-x-4.w-full.sm:w-auto
          / Filter Dropdown
          .relative.flex-1.sm:flex-initial
            = form_with url: users_bookings_path, method: :get, local: true, class: 'flex items-center', id: 'filter-form' do |f|
              .relative.w-full
                = f.select :filter,
                    options_for_select([['All Bookings', 'all'],['Active Bookings', 'active'],['Cancelled Bookings', 'cancelled']], params[:filter] || 'all'),{},
                    { class: 'appearance-none bg-white border border-gray-300 rounded-lg px-4 py-2 pr-8 text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors shadow-sm hover:border-gray-400 w-full',id: 'booking-filter',onchange: 'this.form.submit()'}
                .absolute.inset-y-0.right-0.flex.items-center.pr-2.pointer-events-none
                  %i.fas.fa-chevron-down.text-gray-400.text-xs

      / Notifications Section
      - if current_user.bookings_notification?
        .grid.grid-cols-1.md:grid-cols-2.gap-3.md:gap-4.mb-6.md:mb-8
          / Unpaid Bookings Notification
          - if current_user.unpaid_bookings.any?
            .bg-orange-50.border-l-4.border-orange-500.rounded-lg.p-3.md:p-4.shadow-sm
              .flex.items-start.gap-2.md:gap-3
                %i.fas.fa-credit-card.text-orange-500.text-lg.md:text-xl.mt-1
                .flex-1
                  %h3.text-sm.md:text-base.font-semibold.text-orange-800.mb-1 Payment Required
                  %p.text-orange-700.text-xs.md:text-sm.mb-2
                    #{current_user.unpaid_bookings.count} booking#{current_user.unpaid_bookings.count == 1 ? '' : 's'} awaiting payment
                  %ul.text-orange-600.text-xs.space-y-1.mb-2.md:mb-3
                    - current_user.unpaid_bookings.limit(3).each do |booking|
                      %li.flex.items-center.gap-1
                        %i.fas.fa-circle.text-xs
                        %span.truncate #{booking.car.brand} #{booking.car.model} - #{booking.start_date.strftime('%b %d')}
                    - if current_user.unpaid_bookings.count > 3
                      %li.text-orange-500.font-semibold +#{current_user.unpaid_bookings.count - 2} more...

          / Failed Payments Notification
          - if current_user.failed_payments.any?
            .bg-red-50.border-l-4.border-red-700.rounded-lg.p-3.md:p-4.shadow-sm
              .flex.items-start.gap-2.md:gap-3
                %i.fas.fa-exclamation-circle.text-red-700.text-lg.md:text-xl.mt-1
                .flex-1
                  %h3.text-sm.md:text-base.font-semibold.text-red-800.mb-1 Payment Failed
                  %p.text-red-700.text-xs.md:text-sm.mb-2
                    #{current_user.failed_payments.count} payment#{current_user.failed_payments.count == 1 ? '' : 's'} failed
                  %p.text-red-600.text-xs.mb-2.md:mb-3 Please retry payment or contact support
                  = link_to users_bookings_path, class: 'inline-flex items-center text-red-700 hover:text-red-900 font-semibold text-xs md:text-sm' do
                    Retry Payment
                    %i.fas.fa-arrow-right.ml-1

      / Filter Summary
      - if @bookings.any? || params[:filter].present?
        .mb-6.p-4.bg-blue-50.rounded-lg.border.border-blue-200
          .flex.items-center.justify-between
            .flex.items-center
              %i.fas.fa-filter.mr-2.text-blue-600
              %span.text-sm.font-medium.text-blue-800
                - case params[:filter]
                - when 'active'
                  Showing #{@bookings.count} active booking#{@bookings.count == 1 ? '' : 's'} (pending and confirmed)
                - when 'cancelled'
                  Showing #{@bookings.count} cancelled booking#{@bookings.count == 1 ? '' : 's'}
                - else
                  Showing #{@bookings.count} booking#{@bookings.count == 1 ? '' : 's'} (all statuses)
            - if params[:filter].present? && params[:filter] != 'all'
              = link_to 'Clear Filter', users_bookings_path, class: 'text-sm text-blue-600 hover:text-blue-800 underline'

      / Bookings List
      - if @bookings.any?
        .space-y-8
          - @bookings.each do |booking|
            .bg-white.rounded-2xl.shadow-md.hover:shadow-lg.transition-shadow.duration-300.border.border-gray-100.overflow-hidden.relative
              / Cancel Button - Top Right
              - if (booking.status == 'pending' || booking.status == 'confirmed') && !booking.payment_processed?
                .absolute.top-2.right-2.lg:top-4.lg:right-4.z-10
                  = button_to users_cancel_booking_path(booking.id),
                      method: :patch,
                      class: 'bg-red-600 hover:bg-red-700 text-white px-2 py-1 lg:px-3 lg:py-1 rounded-lg text-xs lg:text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg flex items-center',
                      data: { confirm: 'Are you sure you want to cancel this booking? This action cannot be undone.',turbo_confirm: 'Are you sure you want to cancel this booking? This action cannot be undone.'} do
                    %i.fas.fa-times.mr-1.text-xs.lg:text-sm
                    %span.hidden.sm:inline Cancel
              
              .flex.flex-col.lg:flex-row
                / Car Image Section
                .relative.w-full.lg_w-33.bg-gray-50.flex.items-center.justify-center.p-4.lg:p-6
                  .w-full.h-48.lg:h-full.bg-gray-100.rounded-lg.overflow-hidden
                    = car_main_image(booking.car, size: [400, 300])
                  / Status Badge
                  .absolute.top-4.left-4
                    - badge_class = case booking.status
                    - when 'confirmed' then 'bg-green-100 text-green-800'
                    - when 'pending' then 'bg-yellow-100 text-yellow-800'
                    - when 'cancelled' then 'bg-red-100 text-red-800'
                    - else 'bg-gray-100 text-gray-800'
                    %span.inline-flex.items-center.px-2.py-1.lg:px-3.lg:py-1.rounded-full.text-xs.lg:text-sm.font-medium.shadow-sm{class: badge_class}
                      - if booking.status == 'confirmed'
                        %i.fas.fa-check-circle.mr-1.lg:mr-2.text-xs.lg:text-sm
                      - elsif booking.status == 'pending'
                        %i.fas.fa-clock.mr-1.lg:mr-2.text-xs.lg:text-sm
                      - elsif booking.status == 'cancelled'
                        %i.fas.fa-times-circle.mr-1.lg:mr-2.text-xs.lg:text-sm
                      = booking.status.titleize

                / Details Section
                .flex-1.p-4.lg:p-6
                  .flex.flex-col.h-full
                    / Car Info
                    %div
                      %h3.text-xl.lg:text-2xl.font-bold.text-gray-900.mb-2= "#{booking.car&.brand} #{booking.car&.model}"
                      .flex.flex-wrap.items-center.gap-x-3.lg:gap-x-6.gap-y-2.lg:gap-y-3.mb-4.text-sm.lg:text-base
                        .flex.items-center.text-gray-600
                          %i.fas.fa-calendar.mr-1.lg:mr-2.text-blue-500.text-sm
                          = booking.car&.year
                        .flex.items-center.text-gray-600
                          %i.fas.fa-palette.mr-1.lg:mr-2.text-purple-500.text-sm
                          = booking.car&.color
                        .flex.items-center.text-gray-600
                          %i.fas.fa-tag.mr-1.lg:mr-2.text-green-500.text-sm
                          = booking.car&.category
                      .text-lg.lg:text-xl.font-semibold.text-blue-600.mb-4
                        = number_to_currency(booking.selected_price)
                        - if booking.selected_period == 'daily'
                          %span.text-xs.lg:text-sm.font-normal.text-gray-500.ml-1 per day
                        - elsif booking.selected_period == 'weekly'
                          %span.text-xs.lg:text-sm.font-normal.text-gray-500.ml-1 per week
                        - elsif booking.selected_period == 'monthly'
                          %span.text-xs.lg:text-sm.font-normal.text-gray-500.ml-1 per month

                          

                    / Rental Period
                    .bg-gray-50.rounded-xl.p-3.mb-4.lg:mb-6
                      .flex.flex-col.sm:flex-row.sm:items-center.sm:justify-between.gap-3.sm:gap-4.text-xs.sm:text-sm
                        .flex.flex-wrap.items-center.gap-2.sm:gap-4
                          .flex.items-center
                            %i.fas.fa-calendar-day.mr-1.sm:mr-2.text-blue-500.text-sm
                            %span.font-medium= booking.start_date.strftime('%b %d')
                          %i.fas.fa-arrow-right.text-gray-400.text-xs
                          .flex.items-center
                            %i.fas.fa-calendar-day.mr-1.sm:mr-2.text-blue-500.text-sm
                            %span.font-medium= booking.end_date.strftime('%b %d, %Y')
                        .flex.items-center.border-t.sm:border-t-0.sm:border-l.border-gray-200.pt-2.sm:pt-0.sm:pl-4
                          %i.fas.fa-clock.mr-1.sm:mr-2.text-blue-500.text-sm
                          %span.font-bold.text-blue-600= pluralize((booking.end_date - booking.start_date).to_i, 'day')

                    / Payment Section
                    .mt-auto.pt-3.lg:pt-4.border-t.border-gray-200
                      .flex.flex-col.gap-3.lg:gap-4
                        .flex-1
                          - duration_days = (booking.end_date - booking.start_date).to_i
                          - daily_price = booking.car&.daily_price.to_f || 0

                          / Pricing breakdown based on selected period
                          - if booking.selected_period == 'weekly'
                            - weekly_price = booking.car&.weekly_price.to_f || 0
                            - full_weeks = duration_days / 7
                            - remaining_days = duration_days % 7
                            - total_amount = (full_weeks * weekly_price) + (remaining_days * daily_price)

                            %p.text-xs.sm:text-sm.text-gray-600.mb-2
                              %span.font-medium Pricing:
                              %span.ml-1
                                = "#{full_weeks} week#{full_weeks == 1 ? '' : 's'} × AED #{weekly_price.to_i}"
                                - if remaining_days > 0
                                  %span.ml-1 + #{remaining_days} day#{remaining_days == 1 ? '' : 's'} × AED #{daily_price.to_i}

                          - elsif booking.selected_period == 'monthly'
                            - monthly_price = booking.car&.monthly_price.to_f || 0
                            - full_months = duration_days / 30
                            - remaining_days = duration_days % 30
                            - total_amount = (full_months * monthly_price) + (remaining_days * daily_price)

                            %p.text-xs.sm:text-sm.text-gray-600.mb-2
                              %span.font-medium Pricing:
                              %span.ml-1
                                = "#{full_months} month#{full_months == 1 ? '' : 's'} × AED #{monthly_price.to_i}"
                                - if remaining_days > 0
                                  %span.ml-1 + #{remaining_days} day#{remaining_days == 1 ? '' : 's'} × AED #{daily_price.to_i}

                          - else
                            - total_amount = duration_days * daily_price
                            %p.text-xs.sm:text-sm.text-gray-600.mb-2
                              %span.font-medium Pricing:
                              %span.ml-1= "#{duration_days} days × AED #{daily_price.to_i}"

                          %p.text-xl.lg:text-2xl.font-bold.text-green-600
                            = number_to_currency(total_amount)

                        / Status Pill + Button Container
                        .flex.flex-col.sm:flex-row.items-stretch.sm:items-center.gap-2.sm:gap-3
                          / Status Pill - Always Visible
                          - badge_class = case booking.status
                          - when 'confirmed' then 'bg-green-100 text-green-800'
                          - when 'pending' then 'bg-yellow-100 text-yellow-800'
                          - when 'cancelled' then 'bg-red-100 text-red-800'
                          - else 'bg-gray-100 text-gray-800'
                          %span.inline-flex.items-center.justify-center.px-3.py-1.rounded-full.text-xs.font-medium.shadow-sm.whitespace-nowrap{class: badge_class}
                            - if booking.status == 'confirmed'
                              %i.fas.fa-check-circle.mr-1.text-xs
                            - elsif booking.status == 'pending'
                              %i.fas.fa-clock.mr-1.text-xs
                            - elsif booking.status == 'cancelled'
                              %i.fas.fa-times-circle.mr-1.text-xs
                            = booking.status.titleize


                          / View/Pay Button - Check Document Approval
                          - if !current_user.documents_approved?
                            .payment-disabled.bg-gray-300.text-gray-500.px-4.sm:px-6.py-2.sm:py-3.rounded-lg.text-sm.sm:text-base.font-semibold.cursor-not-allowed.flex.items-center.justify-center.opacity-60{ title: 'Payment is disabled until your documents are approved' }
                              %i.fas.fa-lock.mr-2
                              Payment Disabled
                          - else
                            = link_to users_payment_path(booking.id), class: 'bg-blue-600 hover:bg-blue-700 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg text-sm sm:text-base font-semibold transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center' do
                              %i.fas.fa-eye.mr-2
                              View/Pay Booking
                        

      - else
        .text-center.py-16
          .max-w-md.mx-auto
            .bg-gray-50.rounded-3xl.p-8.flex.flex-col.items-center
              .w-20.h-20.rounded-full.bg-blue-50.flex.items-center.justify-center.mb-6
                %i.fas.fa-calendar-times.text-3xl.text-blue-400
              %h3.text-xl.font-semibold.text-gray-800.mb-3 No Bookings Yet
              %p.text-gray-600.mb-6 It looks like you haven't made any bookings yet. Browse our collection to find your perfect car.
              = link_to cars_path, class: 'bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-3 px-8 rounded-lg shadow hover:from-blue-700 hover:to-blue-800 transition-all duration-200 inline-flex items-center space-x-2' do
                %i.fas.fa-car
                %span Explore Cars
:javascript
  document.addEventListener('DOMContentLoaded', function() {
    // Enhanced cancel booking confirmation
    document.querySelectorAll('form[action*="/cancel"]').forEach(function(form) {
      form.addEventListener('submit', function(e) {
        if (!confirm('Are you sure you want to cancel this booking? This action cannot be undone.')) {
          e.preventDefault();
          return false;
        }
      });
    });
    
    // Filter dropdown enhancement
    const filterSelect = document.getElementById('booking-filter');
    if (filterSelect) {
      filterSelect.addEventListener('change', function() {
        // Add loading state
        const form = document.getElementById('filter-form');
        if (form) {
          const submitButton = document.createElement('button');
          submitButton.type = 'submit';
          submitButton.style.display = 'none';
          form.appendChild(submitButton);
          submitButton.click();
        }
      });
    }
    
    // Original pay button logic for other cases
    document.querySelectorAll('.pay-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        if (btn.dataset.pendingDocs === 'true') {
          e.preventDefault();
          alert("Your documents are under review. We'll notify you once they're approved, and you can proceed with your booking.");
        }
      });
    });
  });
